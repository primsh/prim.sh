openapi: 3.1.0

info:
  title: domain.prim.sh API
  version: 1.0.0
  description: |
    DNS and domain registration for agents. Register domains, manage Cloudflare zones, and configure DNS records with x402 payment (USDC on Base).

    ## Authentication

    All endpoints except `GET /` require x402 payment. The flow:
    1. Make the request — server responds with `402 Payment Required` and a payment challenge.
    2. Sign the EIP-3009 payment authorization with your wallet.
    3. Retry the request with the `Payment-Signature` header set to the signed authorization.

    The wallet address extracted from the payment signature becomes the caller identity (owner of zones and registrations).

    ## Domain Registration Flow

    Domain registration uses dynamic pricing (the cost varies by TLD and premium status):
    1. `GET /v1/domains/search` — Check availability and see pricing.
    2. `POST /v1/domains/quote` — Lock in a price quote (valid for 15 minutes).
    3. `POST /v1/domains/register` — Register using the quote_id. Payment amount is taken from the quote.

servers:
  - url: https://domain.prim.sh

components:
  securitySchemes:
    x402:
      type: apiKey
      in: header
      name: Payment-Signature
      description: |
        EIP-3009 signed payment authorization. Server issues a 402 challenge; client signs and retries.
        See https://prim.sh/pay for the full x402 payment flow.

  schemas:
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              enum:
                - not_found
                - forbidden
                - invalid_request
                - cloudflare_error
                - rate_limited
                - domain_taken
                - quote_expired
                - registrar_error
                - registration_failed
              description: Machine-readable error code.
            message:
              type: string
              description: Human-readable error message.

    ZoneResponse:
      type: object
      required: [id, domain, status, name_servers, owner_wallet, created_at]
      properties:
        id:
          type: string
          description: Zone ID (UUID).
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        domain:
          type: string
          description: Domain name for this zone.
          example: "example.com"
        status:
          type: string
          enum: [pending, active, moved]
          description: Cloudflare zone status.
          example: "pending"
        name_servers:
          type: array
          items:
            type: string
          description: Cloudflare nameservers to configure at your registrar.
          example: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
        owner_wallet:
          type: string
          pattern: "^0x[a-fA-F0-9]{40}$"
          description: Ethereum address of the wallet that created this zone.
          example: "0xAbCd1234567890abcdef1234567890abCDEF1234"
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp of zone creation.
          example: "2026-02-26T12:00:00.000Z"

    RecordResponse:
      type: object
      required: [id, zone_id, type, name, content, ttl, proxied, priority, created_at, updated_at]
      properties:
        id:
          type: string
          description: Record ID.
          example: "r1a2b3c4-d5e6-7890-abcd-ef1234567890"
        zone_id:
          type: string
          description: Zone this record belongs to.
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        type:
          type: string
          enum: [A, AAAA, CNAME, MX, TXT, SRV, CAA, NS]
          description: DNS record type.
          example: "A"
        name:
          type: string
          description: DNS record name (relative to zone, "@" for root).
          example: "@"
        content:
          type: string
          description: Record content (IP for A, hostname for CNAME/MX, text for TXT, etc.).
          example: "203.0.113.42"
        ttl:
          type: integer
          description: Time-to-live in seconds. 1 = automatic (Cloudflare default).
          example: 3600
        proxied:
          type: boolean
          description: Whether traffic is proxied through Cloudflare. Only valid for A/AAAA/CNAME.
          example: false
        priority:
          type: ["integer", "null"]
          description: Priority for MX and SRV records. null for other types.
          example: null
        created_at:
          type: string
          format: date-time
          example: "2026-02-26T12:00:00.000Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-26T12:00:00.000Z"

    DomainSearchResult:
      type: object
      required: [domain, available]
      properties:
        domain:
          type: string
          description: Fully qualified domain name.
          example: "myagent.com"
        available:
          type: boolean
          description: Whether the domain is available for registration.
          example: true
        price:
          type: object
          description: Pricing information. Present when available=true.
          properties:
            register:
              type: number
              description: Registration price in USD.
              example: 12.99
            renew:
              type: number
              description: Annual renewal price in USD. May be omitted.
              example: 12.99
            currency:
              type: string
              example: "USD"
          required: [register, currency]
        premium:
          type: boolean
          description: Whether this is a premium domain (higher price).
          example: false

    QuoteResponse:
      type: object
      required: [quote_id, domain, available, years, registrar_cost_usd, total_cost_usd, currency, expires_at]
      properties:
        quote_id:
          type: string
          description: Quote identifier. Pass this to POST /v1/domains/register.
          example: "q1a2b3c4-d5e6-7890-abcd-ef1234567890"
        domain:
          type: string
          description: Domain name being quoted.
          example: "myagent.com"
        available:
          type: boolean
          example: true
        years:
          type: integer
          description: Registration period in years.
          example: 1
        registrar_cost_usd:
          type: number
          description: Base registrar cost in USD.
          example: 10.99
        total_cost_usd:
          type: number
          description: Total cost including fees, in USD. This is the x402 payment amount.
          example: 12.99
        currency:
          type: string
          example: "USD"
        expires_at:
          type: string
          format: date-time
          description: When this quote expires. Must register before this time.
          example: "2026-02-26T12:15:00.000Z"

    RegisterResponse:
      type: object
      required: [domain, registered, zone_id, nameservers, order_amount_usd, ns_configured, recovery_token]
      properties:
        domain:
          type: string
          example: "myagent.com"
        registered:
          type: boolean
          example: true
        zone_id:
          type: ["string", "null"]
          description: Cloudflare zone ID created for this domain. null if zone creation failed.
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        nameservers:
          type: ["array", "null"]
          items:
            type: string
          description: Nameservers to configure at your registrar. null if zone creation failed.
          example: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
        order_amount_usd:
          type: number
          description: Amount charged for this registration.
          example: 12.99
        ns_configured:
          type: boolean
          description: Whether nameservers were automatically configured at the registrar.
          example: true
        recovery_token:
          type: ["string", "null"]
          description: Token to retry zone/NS setup if it partially failed. Store this securely.
          example: "rt_abc123def456"

    RecoverResponse:
      type: object
      required: [domain, zone_id, nameservers, ns_configured]
      properties:
        domain:
          type: string
          example: "myagent.com"
        zone_id:
          type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        nameservers:
          type: array
          items:
            type: string
          example: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
        ns_configured:
          type: boolean
          example: true

    ConfigureNsResponse:
      type: object
      required: [domain, nameservers, ns_configured]
      properties:
        domain:
          type: string
          example: "myagent.com"
        nameservers:
          type: array
          items:
            type: string
          example: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
        ns_configured:
          type: boolean
          example: true

    RegistrationStatusResponse:
      type: object
      required: [domain, purchased, zone_id, zone_status, ns_configured_at_registrar, ns_propagated, ns_expected, ns_actual, zone_active, all_ready, next_action]
      properties:
        domain:
          type: string
          example: "myagent.com"
        purchased:
          type: boolean
          example: true
        zone_id:
          type: ["string", "null"]
          description: Cloudflare zone ID. null if zone has not been created yet.
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        zone_status:
          type: ["string", "null"]
          enum: [pending, active, moved, null]
          description: Cloudflare zone activation status. null if no zone yet.
          example: "pending"
        ns_configured_at_registrar:
          type: boolean
          description: Whether Cloudflare nameservers are set at the registrar.
          example: true
        ns_propagated:
          type: boolean
          description: Whether nameserver changes have propagated globally.
          example: false
        ns_expected:
          type: array
          items:
            type: string
          description: Cloudflare nameservers that should be configured.
          example: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
        ns_actual:
          type: array
          items:
            type: string
          description: Nameservers currently observed for the domain.
          example: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
        zone_active:
          type: boolean
          description: Whether the Cloudflare zone is active (traffic routing through CF).
          example: false
        all_ready:
          type: boolean
          description: true when zone is active and everything is configured. Domain is fully live.
          example: false
        next_action:
          type: ["string", "null"]
          description: Human-readable guidance on what to do next. null when all_ready is true.
          example: "Waiting for nameserver propagation (typically 15–60 minutes)"

    VerifyResponse:
      type: object
      required: [domain, nameservers, records, all_propagated, zone_status]
      properties:
        domain:
          type: string
          example: "myagent.com"
        nameservers:
          type: object
          required: [expected, actual, propagated]
          properties:
            expected:
              type: array
              items:
                type: string
              example: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
            actual:
              type: array
              items:
                type: string
              example: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
            propagated:
              type: boolean
              example: true
        records:
          type: array
          items:
            type: object
            required: [type, name, expected, actual, propagated]
            properties:
              type:
                type: string
                enum: [A, AAAA, CNAME, MX, TXT, SRV, CAA, NS]
              name:
                type: string
              expected:
                type: string
              actual:
                type: ["string", "null"]
              propagated:
                type: boolean
        all_propagated:
          type: boolean
          description: true when all NS and record checks pass.
          example: false
        zone_status:
          type: ["string", "null"]
          enum: [pending, active, moved, null]
          example: "active"

    ActivateResponse:
      type: object
      required: [zone_id, status, activation_requested]
      properties:
        zone_id:
          type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        status:
          type: string
          enum: [pending, active, moved]
          example: "pending"
        activation_requested:
          type: boolean
          example: true

    MailSetupResponse:
      type: object
      required: [records]
      properties:
        records:
          type: array
          items:
            type: object
            required: [type, name, action]
            properties:
              type:
                type: string
                enum: [A, AAAA, CNAME, MX, TXT, SRV, CAA, NS]
              name:
                type: string
              action:
                type: string
                enum: [created, updated]
          description: DNS records that were created or updated.

    BatchRecordsResponse:
      type: object
      required: [created, updated, deleted]
      properties:
        created:
          type: array
          items:
            $ref: "#/components/schemas/RecordResponse"
        updated:
          type: array
          items:
            $ref: "#/components/schemas/RecordResponse"
        deleted:
          type: array
          items:
            type: object
            required: [id]
            properties:
              id:
                type: string

paths:
  /:
    get:
      operationId: healthCheck
      summary: Health check
      description: Returns service status. Free — no x402 payment required.
      security: []
      responses:
        "200":
          description: Service is running.
          content:
            application/json:
              schema:
                type: object
                required: [service, status]
                properties:
                  service:
                    type: string
                    example: "domain.sh"
                  status:
                    type: string
                    example: "ok"
              example:
                service: "domain.sh"
                status: "ok"

  /v1/domains/search:
    get:
      operationId: searchDomains
      summary: Search domain availability
      description: |
        Check availability and pricing for one or more domain names. Pass a query (e.g. "myagent")
        and optionally a list of TLDs to check. Returns availability and registration price for each.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: query
          in: query
          required: true
          description: Domain name to search (without TLD, e.g. "myagent").
          schema:
            type: string
          example: "myagent"
        - name: tlds
          in: query
          description: Comma-separated TLDs to check (e.g. "com,xyz,io"). Defaults to common TLDs.
          schema:
            type: string
          example: "com,xyz,io"
      responses:
        "200":
          description: Search results with availability and pricing.
          content:
            application/json:
              schema:
                type: object
                required: [results]
                properties:
                  results:
                    type: array
                    items:
                      $ref: "#/components/schemas/DomainSearchResult"
              example:
                results:
                  - domain: "myagent.com"
                    available: true
                    price:
                      register: 12.99
                      renew: 12.99
                      currency: "USD"
                    premium: false
                  - domain: "myagent.xyz"
                    available: true
                    price:
                      register: 1.99
                      renew: 9.99
                      currency: "USD"
                    premium: false
        "400":
          description: Missing or invalid query parameter.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "invalid_request"
                  message: "query parameter is required"
        "402":
          description: x402 payment required.
        "503":
          description: Registrar service unavailable.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/domains/quote:
    post:
      operationId: quoteDomain
      summary: Get price quote
      description: |
        Get a time-limited price quote for registering a domain. Quote is valid for 15 minutes.
        Pass the returned `quote_id` to `POST /v1/domains/register`.
      security:
        - x402: []
      x-price: "$0.001"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [domain]
              properties:
                domain:
                  type: string
                  description: Fully qualified domain name to quote.
                  example: "myagent.com"
                years:
                  type: integer
                  description: Registration period in years (default 1).
                  example: 1
            example:
              domain: "myagent.com"
              years: 1
      responses:
        "200":
          description: Price quote.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuoteResponse"
              example:
                quote_id: "q1a2b3c4-d5e6-7890-abcd-ef1234567890"
                domain: "myagent.com"
                available: true
                years: 1
                registrar_cost_usd: 10.99
                total_cost_usd: 12.99
                currency: "USD"
                expires_at: "2026-02-26T12:15:00.000Z"
        "400":
          description: Domain not available or invalid request.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "invalid_request"
                  message: "Domain myagent.com is not available"
        "402":
          description: x402 payment required.
        "403":
          description: Missing wallet address in payment.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "503":
          description: Registrar service unavailable.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/domains/register:
    post:
      operationId: registerDomain
      summary: Register domain
      description: |
        Register a domain using a valid quote. The x402 payment amount is taken from the quote's
        `total_cost_usd` — this endpoint uses dynamic pricing, not a fixed price.

        Flow:
        1. `POST /v1/domains/quote` → get `quote_id`
        2. Pay the x402 challenge with the quoted amount
        3. `POST /v1/domains/register` with `quote_id` → domain registered

        After registration, a Cloudflare zone is automatically created and nameservers are
        configured at the registrar. If this partially fails, use the `recovery_token` with
        `POST /v1/domains/recover` to retry.
      security:
        - x402: []
      x-price: dynamic (from quote)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [quote_id]
              properties:
                quote_id:
                  type: string
                  description: Quote ID from POST /v1/domains/quote. Valid for 15 minutes.
                  example: "q1a2b3c4-d5e6-7890-abcd-ef1234567890"
            example:
              quote_id: "q1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "201":
          description: Domain registered successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponse"
              example:
                domain: "myagent.com"
                registered: true
                zone_id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                nameservers: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                order_amount_usd: 12.99
                ns_configured: true
                recovery_token: "rt_abc123def456"
        "400":
          description: Invalid or missing quote_id.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "invalid_request"
                  message: "quote_id is required"
        "402":
          description: x402 payment required (amount from quote).
        "403":
          description: Could not determine payer wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Quote not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "not_found"
                  message: "Quote not found"
        "410":
          description: Quote has expired.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "quote_expired"
                  message: "Quote has expired"
        "502":
          description: Registrar error during domain purchase.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "registrar_error"
                  message: "Registrar failed to process domain registration"

  /v1/domains/recover:
    post:
      operationId: recoverRegistration
      summary: Recover registration
      description: |
        Retry Cloudflare zone creation and/or nameserver configuration after a partial failure
        during `POST /v1/domains/register`. Use the `recovery_token` returned from registration.

        Free endpoint — recovery_token provides sufficient authorization.
        Wallet identity is still required (include payment-signature header).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [recovery_token]
              properties:
                recovery_token:
                  type: string
                  description: Recovery token from the original RegisterResponse.
                  example: "rt_abc123def456"
            example:
              recovery_token: "rt_abc123def456"
      responses:
        "200":
          description: Recovery successful.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecoverResponse"
              example:
                domain: "myagent.com"
                zone_id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                nameservers: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                ns_configured: true
        "400":
          description: Missing or invalid recovery_token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Recovery token belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Recovery token not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Cloudflare error during zone creation.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/domains/{domain}/status:
    get:
      operationId: getDomainStatus
      summary: Registration status
      description: |
        Check the full post-registration pipeline status for a domain your wallet registered.
        Useful for polling after registration to know when the domain is fully live.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: domain
          in: path
          required: true
          description: Fully qualified domain name.
          schema:
            type: string
          example: "myagent.com"
      responses:
        "200":
          description: Registration status details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegistrationStatusResponse"
              example:
                domain: "myagent.com"
                purchased: true
                zone_id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                zone_status: "pending"
                ns_configured_at_registrar: true
                ns_propagated: false
                ns_expected: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                ns_actual: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                zone_active: false
                all_ready: false
                next_action: "Waiting for nameserver propagation (typically 15-60 minutes)"
        "402":
          description: x402 payment required.
        "403":
          description: Domain registered by a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Domain not found in registration records.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/domains/{domain}/configure-ns:
    post:
      operationId: configureNs
      summary: Configure nameservers
      description: |
        Retry nameserver configuration at the registrar for a domain your wallet registered.
        Free endpoint — wallet ownership of the registration is sufficient authorization.
      security: []
      parameters:
        - name: domain
          in: path
          required: true
          description: Fully qualified domain name.
          schema:
            type: string
          example: "myagent.com"
      responses:
        "200":
          description: Nameservers configured.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfigureNsResponse"
              example:
                domain: "myagent.com"
                nameservers: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                ns_configured: true
        "400":
          description: Invalid request.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Domain registered by a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Domain not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Registrar or Cloudflare error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/zones:
    post:
      operationId: createZone
      summary: Create zone
      description: |
        Create a Cloudflare DNS zone for a domain. The zone is owned by the paying wallet.
        Returns nameservers to configure at your registrar.
      security:
        - x402: []
      x-price: "$0.05"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [domain]
              properties:
                domain:
                  type: string
                  description: Domain name for the zone.
                  example: "example.com"
            example:
              domain: "example.com"
      responses:
        "201":
          description: Zone created.
          content:
            application/json:
              schema:
                type: object
                required: [zone]
                properties:
                  zone:
                    $ref: "#/components/schemas/ZoneResponse"
              example:
                zone:
                  id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                  domain: "example.com"
                  status: "pending"
                  name_servers: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                  owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                  created_at: "2026-02-26T12:00:00.000Z"
        "400":
          description: Invalid domain or domain already has a zone.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalid_request:
                  value:
                    error:
                      code: "invalid_request"
                      message: "Invalid domain name"
                domain_taken:
                  value:
                    error:
                      code: "domain_taken"
                      message: "A zone for this domain already exists"
        "402":
          description: x402 payment required.
        "403":
          description: Missing wallet address in payment.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Cloudflare error creating zone.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "cloudflare_error"
                  message: "Failed to create zone in Cloudflare"

    get:
      operationId: listZones
      summary: List zones
      description: Returns all DNS zones owned by the paying wallet address.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: limit
          in: query
          description: Number of zones per page (1–100, default 20).
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: page
          in: query
          description: Page number (1-based, default 1).
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
      responses:
        "200":
          description: List of zones.
          content:
            application/json:
              schema:
                type: object
                required: [zones, meta]
                properties:
                  zones:
                    type: array
                    items:
                      $ref: "#/components/schemas/ZoneResponse"
                  meta:
                    type: object
                    required: [page, per_page, total]
                    properties:
                      page:
                        type: integer
                        example: 1
                      per_page:
                        type: integer
                        example: 20
                      total:
                        type: integer
                        example: 3
              example:
                zones:
                  - id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                    domain: "example.com"
                    status: "active"
                    name_servers: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                    owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                    created_at: "2026-02-26T12:00:00.000Z"
                meta:
                  page: 1
                  per_page: 20
                  total: 1
        "402":
          description: x402 payment required.
        "403":
          description: Missing wallet address in payment.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/zones/{id}:
    get:
      operationId: getZone
      summary: Get zone
      description: Returns details for a single zone. Caller must own the zone.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Zone details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ZoneResponse"
              example:
                id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                domain: "example.com"
                status: "active"
                name_servers: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                created_at: "2026-02-26T12:00:00.000Z"
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "forbidden"
                  message: "Zone belongs to a different wallet"
        "404":
          description: Zone not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "not_found"
                  message: "Zone not found"

    delete:
      operationId: deleteZone
      summary: Delete zone
      description: |
        Deletes a Cloudflare DNS zone and all its records. Caller must own the zone.
        This action cannot be undone.
      security:
        - x402: []
      x-price: "$0.01"
      parameters:
        - name: id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Zone deleted.
          content:
            application/json:
              schema:
                type: object
              example: {}
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Cloudflare error deleting zone.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/zones/{zone_id}/activate:
    put:
      operationId: activateZone
      summary: Activate zone
      description: |
        Request Cloudflare to immediately re-check nameserver activation for a pending zone.
        Use this after configuring nameservers to speed up activation (instead of waiting for
        Cloudflare's periodic check).
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Activation check requested.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActivateResponse"
              example:
                zone_id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                status: "pending"
                activation_requested: true
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "429":
          description: Rate limited — too many activation requests.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "rate_limited"
                  message: "Too many activation requests"
        "502":
          description: Cloudflare error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/zones/{zone_id}/verify:
    get:
      operationId: verifyZone
      summary: Verify zone propagation
      description: |
        Check DNS propagation for a zone — verifies nameservers and all DNS records.
        Use this to confirm changes have propagated before activating or after updating records.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Verification results.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyResponse"
              example:
                domain: "example.com"
                nameservers:
                  expected: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                  actual: ["ns1.cloudflare.com", "ns2.cloudflare.com"]
                  propagated: true
                records:
                  - type: "A"
                    name: "@"
                    expected: "203.0.113.42"
                    actual: "203.0.113.42"
                    propagated: true
                all_propagated: true
                zone_status: "active"
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/zones/{zone_id}/mail-setup:
    post:
      operationId: setupMail
      summary: Setup mail DNS records
      description: |
        Configure all DNS records required for email delivery: MX, SPF (TXT), DMARC (TXT),
        and optionally DKIM (TXT). Also creates an A record pointing to the mail server IP.

        Use this after registering a custom domain with email.prim.sh.
      security:
        - x402: []
      x-price: "$0.005"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [mail_server, mail_server_ip]
              properties:
                mail_server:
                  type: string
                  description: Mail server hostname (e.g. "mail.example.com").
                  example: "mail.example.com"
                mail_server_ip:
                  type: string
                  description: Mail server IP address for the A record.
                  example: "203.0.113.42"
                dkim:
                  type: object
                  description: Optional DKIM public keys.
                  properties:
                    rsa:
                      type: object
                      required: [selector, public_key]
                      properties:
                        selector:
                          type: string
                          example: "mail"
                        public_key:
                          type: string
                          example: "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA..."
                    ed25519:
                      type: object
                      required: [selector, public_key]
                      properties:
                        selector:
                          type: string
                          example: "mail2"
                        public_key:
                          type: string
                          example: "abc123..."
            example:
              mail_server: "mail.example.com"
              mail_server_ip: "203.0.113.42"
              dkim:
                rsa:
                  selector: "mail"
                  public_key: "MIIBIjAN..."
      responses:
        "200":
          description: Mail DNS records configured.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MailSetupResponse"
              example:
                records:
                  - type: "A"
                    name: "mail"
                    action: "created"
                  - type: "MX"
                    name: "@"
                    action: "created"
                  - type: "TXT"
                    name: "@"
                    action: "created"
                  - type: "TXT"
                    name: "_dmarc"
                    action: "created"
                  - type: "TXT"
                    name: "mail._domainkey"
                    action: "created"
        "400":
          description: Invalid request body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Cloudflare error creating records.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/zones/{zone_id}/records/batch:
    post:
      operationId: batchRecords
      summary: Batch record operations
      description: |
        Create, update, and delete DNS records in a single request. All operations are attempted;
        partial failures are possible (check the returned arrays).
      security:
        - x402: []
      x-price: "$0.005"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                create:
                  type: array
                  items:
                    type: object
                    required: [type, name, content]
                    properties:
                      type:
                        type: string
                        enum: [A, AAAA, CNAME, MX, TXT, SRV, CAA, NS]
                      name:
                        type: string
                      content:
                        type: string
                      ttl:
                        type: integer
                      proxied:
                        type: boolean
                      priority:
                        type: integer
                update:
                  type: array
                  items:
                    type: object
                    required: [id]
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        enum: [A, AAAA, CNAME, MX, TXT, SRV, CAA, NS]
                      name:
                        type: string
                      content:
                        type: string
                      ttl:
                        type: integer
                      proxied:
                        type: boolean
                      priority:
                        type: integer
                delete:
                  type: array
                  items:
                    type: object
                    required: [id]
                    properties:
                      id:
                        type: string
            example:
              create:
                - type: "A"
                  name: "www"
                  content: "203.0.113.42"
                  ttl: 3600
              delete:
                - id: "r1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Batch results.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchRecordsResponse"
              example:
                created:
                  - id: "r2a3b4c5-d6e7-8901-bcde-f12345678901"
                    zone_id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                    type: "A"
                    name: "www"
                    content: "203.0.113.42"
                    ttl: 3600
                    proxied: false
                    priority: null
                    created_at: "2026-02-26T12:00:00.000Z"
                    updated_at: "2026-02-26T12:00:00.000Z"
                updated: []
                deleted:
                  - id: "r1a2b3c4-d5e6-7890-abcd-ef1234567890"
        "400":
          description: Invalid request body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Cloudflare error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/zones/{zone_id}/records:
    post:
      operationId: createRecord
      summary: Create record
      description: Create a single DNS record in a zone.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, name, content]
              properties:
                type:
                  type: string
                  enum: [A, AAAA, CNAME, MX, TXT, SRV, CAA, NS]
                  description: DNS record type.
                  example: "A"
                name:
                  type: string
                  description: Record name relative to zone root. Use "@" for root.
                  example: "@"
                content:
                  type: string
                  description: Record content (IP for A/AAAA, hostname for CNAME/MX, text for TXT).
                  example: "203.0.113.42"
                ttl:
                  type: integer
                  description: TTL in seconds. 1 = automatic.
                  example: 3600
                proxied:
                  type: boolean
                  description: Proxy through Cloudflare (A/AAAA/CNAME only).
                  example: false
                priority:
                  type: integer
                  description: Priority for MX/SRV records.
                  example: 10
            example:
              type: "A"
              name: "@"
              content: "203.0.113.42"
              ttl: 3600
      responses:
        "201":
          description: Record created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecordResponse"
              example:
                id: "r1a2b3c4-d5e6-7890-abcd-ef1234567890"
                zone_id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                type: "A"
                name: "@"
                content: "203.0.113.42"
                ttl: 3600
                proxied: false
                priority: null
                created_at: "2026-02-26T12:00:00.000Z"
                updated_at: "2026-02-26T12:00:00.000Z"
        "400":
          description: Invalid record parameters.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Cloudflare error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      operationId: listRecords
      summary: List records
      description: Returns all DNS records in a zone.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: List of records.
          content:
            application/json:
              schema:
                type: object
                required: [records]
                properties:
                  records:
                    type: array
                    items:
                      $ref: "#/components/schemas/RecordResponse"
              example:
                records:
                  - id: "r1a2b3c4-d5e6-7890-abcd-ef1234567890"
                    zone_id: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
                    type: "A"
                    name: "@"
                    content: "203.0.113.42"
                    ttl: 3600
                    proxied: false
                    priority: null
                    created_at: "2026-02-26T12:00:00.000Z"
                    updated_at: "2026-02-26T12:00:00.000Z"
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/zones/{zone_id}/records/{id}:
    get:
      operationId: getRecord
      summary: Get record
      description: Returns a single DNS record.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        - name: id
          in: path
          required: true
          description: Record ID.
          schema:
            type: string
          example: "r1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Record details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecordResponse"
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone or record not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      operationId: updateRecord
      summary: Update record
      description: Update a DNS record. All fields are optional — only include fields to change.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        - name: id
          in: path
          required: true
          description: Record ID.
          schema:
            type: string
          example: "r1a2b3c4-d5e6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: [A, AAAA, CNAME, MX, TXT, SRV, CAA, NS]
                name:
                  type: string
                content:
                  type: string
                ttl:
                  type: integer
                proxied:
                  type: boolean
                priority:
                  type: integer
            example:
              content: "203.0.113.99"
      responses:
        "200":
          description: Record updated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecordResponse"
        "400":
          description: Invalid record parameters.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone or record not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Cloudflare error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      operationId: deleteRecord
      summary: Delete record
      description: Delete a DNS record from a zone.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: zone_id
          in: path
          required: true
          description: Zone ID.
          schema:
            type: string
          example: "z1a2b3c4-d5e6-7890-abcd-ef1234567890"
        - name: id
          in: path
          required: true
          description: Record ID.
          schema:
            type: string
          example: "r1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Record deleted.
          content:
            application/json:
              schema:
                type: object
              example: {}
        "402":
          description: x402 payment required.
        "403":
          description: Zone belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Zone or record not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Cloudflare error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
