openapi: 3.1.0

info:
  title: mem.prim.sh API
  version: 1.0.0
  description: |
    Vector memory and cache for agents. Semantic search collections backed by Qdrant, plus a lightweight key-value cache. x402 payment (USDC on Base) is the sole auth.

    ## Authentication

    All endpoints except `GET /` and `GET /llms.txt` require x402 payment. The flow:
    1. Make the request — server responds with `402 Payment Required` and a payment challenge.
    2. Sign the EIP-3009 payment authorization with your wallet.
    3. Retry the request with the `Payment-Signature` header set to the signed authorization.

    The wallet address extracted from the payment signature becomes the caller identity (owner of collections and cache namespaces).

servers:
  - url: https://mem.prim.sh

components:
  securitySchemes:
    x402:
      type: apiKey
      in: header
      name: Payment-Signature
      description: |
        EIP-3009 signed payment authorization. Server issues a 402 challenge; client signs and retries.
        See https://prim.sh/pay for the full x402 payment flow.

  schemas:
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              enum:
                - not_found
                - forbidden
                - invalid_request
                - qdrant_error
                - embedding_error
                - rate_limited
                - collection_name_taken
              description: Machine-readable error code.
            message:
              type: string
              description: Human-readable error message.

    CollectionResponse:
      type: object
      required: [id, name, owner_wallet, dimension, distance, document_count, created_at]
      properties:
        id:
          type: string
          description: Unique collection identifier (UUID).
          example: "c1a2b3d4-e5f6-7890-abcd-ef1234567890"
        name:
          type: string
          description: Collection name (unique per wallet).
          example: "agent-notes"
        owner_wallet:
          type: string
          pattern: "^0x[a-fA-F0-9]{40}$"
          description: Ethereum address of the wallet that created this collection.
          example: "0xAbCd1234567890abcdef1234567890abCDEF1234"
        dimension:
          type: integer
          description: Vector dimension for the collection's embedding model.
          example: 1536
        distance:
          type: string
          enum: ["Cosine", "Euclid", "Dot"]
          description: Distance metric used for similarity search.
          example: "Cosine"
        document_count:
          type: ["integer", "null"]
          description: Live Qdrant points count. null in list responses to avoid N+1 calls.
          example: 42
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp of collection creation.
          example: "2026-02-26T12:00:00.000Z"

    UpsertDocument:
      type: object
      required: [text]
      properties:
        id:
          type: string
          format: uuid
          description: Document UUID. Auto-generated if omitted.
          example: "d1a2b3c4-e5f6-7890-abcd-ef1234567890"
        text:
          type: string
          description: Text content to embed and store.
          example: "The capital of France is Paris."
        metadata:
          type: object
          additionalProperties: true
          description: Arbitrary key-value metadata stored alongside the vector.
          example: {"source": "wikipedia", "lang": "en"}

    QueryMatch:
      type: object
      required: [id, score, text, metadata]
      properties:
        id:
          type: string
          description: Document ID (UUID).
          example: "d1a2b3c4-e5f6-7890-abcd-ef1234567890"
        score:
          type: number
          description: Similarity score (higher = more similar).
          example: 0.92
        text:
          type: string
          description: Stored text content.
          example: "The capital of France is Paris."
        metadata:
          type: object
          additionalProperties: true
          description: Stored metadata.
          example: {"source": "wikipedia", "lang": "en"}

    CacheGetResponse:
      type: object
      required: [namespace, key, value, expires_at]
      properties:
        namespace:
          type: string
          description: Cache namespace.
          example: "agent-session"
        key:
          type: string
          description: Cache key.
          example: "last-query-result"
        value:
          description: Stored value (any JSON-serializable type).
          example: {"result": "ok", "count": 3}
        expires_at:
          type: ["string", "null"]
          format: date-time
          description: ISO 8601 expiry timestamp, or null if the entry never expires.
          example: null

paths:
  /:
    get:
      operationId: healthCheck
      summary: Health check / llms.txt
      description: Returns service info as plain text (llms.txt format). Free — no x402 payment required.
      security: []
      responses:
        "200":
          description: Service info.
          content:
            text/plain:
              schema:
                type: string

  /llms.txt:
    get:
      operationId: llmsTxt
      summary: Machine-readable API reference
      description: Returns the full API reference in llms.txt format. Free — no x402 payment required.
      security: []
      responses:
        "200":
          description: API reference text.
          content:
            text/plain:
              schema:
                type: string

  /v1/collections:
    post:
      operationId: createCollection
      summary: Create a collection
      description: |
        Creates a new vector collection owned by the paying wallet address.

        Collection names must be unique per wallet. The embedding model and dimension are
        determined server-side (default: text-embedding-3-small, 1536 dims, Cosine distance).
        Pass `distance` or `dimension` to override.
      security:
        - x402: []
      x-price: "$0.01"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  description: Collection name. Must be unique per wallet.
                  example: "agent-notes"
                distance:
                  type: string
                  enum: ["Cosine", "Euclid", "Dot"]
                  description: Distance metric (default Cosine).
                  example: "Cosine"
                dimension:
                  type: integer
                  description: Vector dimension (default 1536 for text-embedding-3-small).
                  example: 1536
            example:
              name: "agent-notes"
      responses:
        "201":
          description: Collection created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CollectionResponse"
              example:
                id: "c1a2b3d4-e5f6-7890-abcd-ef1234567890"
                name: "agent-notes"
                owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                dimension: 1536
                distance: "Cosine"
                document_count: 0
                created_at: "2026-02-26T12:00:00.000Z"
        "400":
          description: Invalid request body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "invalid_request"
                  message: "name is required"
        "402":
          description: x402 payment required.
        "403":
          description: Missing wallet address in payment.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "forbidden"
                  message: "No wallet address in payment"
        "409":
          description: Collection name already exists for this wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "collection_name_taken"
                  message: "A collection with that name already exists"
        "502":
          description: Upstream Qdrant error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "qdrant_error"
                  message: "Failed to create collection in Qdrant"

    get:
      operationId: listCollections
      summary: List collections
      description: |
        Returns all collections owned by the paying wallet address.

        Pagination is page-based. Default page size is 20, maximum is 100.
        `document_count` is null in list responses to avoid N+1 Qdrant calls — use `GET /v1/collections/{id}` for a live count.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: limit
          in: query
          description: Number of collections per page (1–100, default 20).
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: page
          in: query
          description: Page number (1-based, default 1).
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
      responses:
        "200":
          description: List of collections.
          content:
            application/json:
              schema:
                type: object
                required: [collections, meta]
                properties:
                  collections:
                    type: array
                    items:
                      $ref: "#/components/schemas/CollectionResponse"
                  meta:
                    type: object
                    required: [page, per_page, total]
                    properties:
                      page:
                        type: integer
                        description: Current page number.
                        example: 1
                      per_page:
                        type: integer
                        description: Number of items per page.
                        example: 20
                      total:
                        type: integer
                        description: Total number of collections.
                        example: 2
              example:
                collections:
                  - id: "c1a2b3d4-e5f6-7890-abcd-ef1234567890"
                    name: "agent-notes"
                    owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                    dimension: 1536
                    distance: "Cosine"
                    document_count: null
                    created_at: "2026-02-26T12:00:00.000Z"
                meta:
                  page: 1
                  per_page: 20
                  total: 1
        "402":
          description: x402 payment required.
        "403":
          description: Missing wallet address in payment.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/collections/{id}:
    get:
      operationId: getCollection
      summary: Get collection details
      description: Returns details for a single collection including live document_count. Caller must own the collection.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Collection ID (UUID).
          schema:
            type: string
          example: "c1a2b3d4-e5f6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Collection details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CollectionResponse"
              example:
                id: "c1a2b3d4-e5f6-7890-abcd-ef1234567890"
                name: "agent-notes"
                owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                dimension: 1536
                distance: "Cosine"
                document_count: 42
                created_at: "2026-02-26T12:00:00.000Z"
        "402":
          description: x402 payment required.
        "403":
          description: Collection belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "forbidden"
                  message: "Collection belongs to a different wallet"
        "404":
          description: Collection not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "not_found"
                  message: "Collection not found"

    delete:
      operationId: deleteCollection
      summary: Delete a collection
      description: |
        Deletes a collection and all its documents. This is irreversible.
        Caller must own the collection.
      security:
        - x402: []
      x-price: "$0.01"
      parameters:
        - name: id
          in: path
          required: true
          description: Collection ID (UUID).
          schema:
            type: string
          example: "c1a2b3d4-e5f6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Collection deleted.
          content:
            application/json:
              schema:
                type: object
              example: {}
        "402":
          description: x402 payment required.
        "403":
          description: Collection belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Collection not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Upstream Qdrant error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/collections/{id}/upsert:
    post:
      operationId: upsertDocuments
      summary: Upsert documents
      description: |
        Embeds and stores documents in the collection. Each document is embedded using the
        collection's model and upserted into Qdrant. Existing documents with the same ID are replaced.

        Documents without an explicit `id` get auto-generated UUIDs returned in `ids`.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Collection ID (UUID).
          schema:
            type: string
          example: "c1a2b3d4-e5f6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [documents]
              properties:
                documents:
                  type: array
                  items:
                    $ref: "#/components/schemas/UpsertDocument"
                  description: Documents to embed and upsert.
            example:
              documents:
                - text: "The capital of France is Paris."
                  metadata: {"source": "wikipedia"}
                - text: "Berlin is the capital of Germany."
                  metadata: {"source": "wikipedia"}
      responses:
        "200":
          description: Documents upserted.
          content:
            application/json:
              schema:
                type: object
                required: [upserted, ids]
                properties:
                  upserted:
                    type: integer
                    description: Number of documents upserted.
                    example: 2
                  ids:
                    type: array
                    items:
                      type: string
                    description: IDs of the upserted documents (in input order).
                    example: ["d1a2b3c4-e5f6-7890-abcd-ef1234567890", "e1a2b3c4-e5f6-7890-abcd-ef1234567890"]
              example:
                upserted: 2
                ids:
                  - "d1a2b3c4-e5f6-7890-abcd-ef1234567890"
                  - "e1a2b3c4-e5f6-7890-abcd-ef1234567890"
        "400":
          description: Invalid request body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "402":
          description: x402 payment required.
        "403":
          description: Collection belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Collection not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Upstream Qdrant or embedding error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                qdrant_error:
                  value:
                    error:
                      code: "qdrant_error"
                      message: "Failed to upsert documents"
                embedding_error:
                  value:
                    error:
                      code: "embedding_error"
                      message: "Failed to embed documents"

  /v1/collections/{id}/query:
    post:
      operationId: queryCollection
      summary: Semantic query
      description: |
        Embeds the query text and searches the collection for semantically similar documents.
        Returns matches sorted by descending score. Use `top_k` to control result count (default 10).

        Pass a Qdrant-native `filter` object to apply metadata filtering alongside semantic search.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Collection ID (UUID).
          schema:
            type: string
          example: "c1a2b3d4-e5f6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [text]
              properties:
                text:
                  type: string
                  description: Query text to embed and search.
                  example: "What is the capital of France?"
                top_k:
                  type: integer
                  description: Maximum number of results to return (default 10).
                  example: 5
                filter:
                  description: Qdrant-native filter passthrough for metadata filtering.
                  example: {"must": [{"key": "source", "match": {"value": "wikipedia"}}]}
            example:
              text: "What is the capital of France?"
              top_k: 5
      responses:
        "200":
          description: Semantic search results.
          content:
            application/json:
              schema:
                type: object
                required: [matches]
                properties:
                  matches:
                    type: array
                    items:
                      $ref: "#/components/schemas/QueryMatch"
              example:
                matches:
                  - id: "d1a2b3c4-e5f6-7890-abcd-ef1234567890"
                    score: 0.92
                    text: "The capital of France is Paris."
                    metadata: {"source": "wikipedia"}
        "400":
          description: Invalid request body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "402":
          description: x402 payment required.
        "403":
          description: Collection belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Collection not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Upstream Qdrant or embedding error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/cache/{namespace}/{key}:
    put:
      operationId: setCache
      summary: Set cache entry
      description: |
        Stores a value under the given namespace and key. The namespace is scoped to the paying wallet.
        Pass `ttl` in seconds for auto-expiry. Omit or pass null for a permanent entry.
        Overwrites any existing entry at the same namespace/key.
      security:
        - x402: []
      x-price: "$0.0001"
      parameters:
        - name: namespace
          in: path
          required: true
          description: Cache namespace (scoped to wallet).
          schema:
            type: string
          example: "agent-session"
        - name: key
          in: path
          required: true
          description: Cache key.
          schema:
            type: string
          example: "last-query-result"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [value]
              properties:
                value:
                  description: Value to store (any JSON-serializable type).
                  example: {"result": "ok", "count": 3}
                ttl:
                  type: ["integer", "null"]
                  description: TTL in seconds. Omit or null for permanent.
                  example: 3600
            example:
              value: {"result": "ok", "count": 3}
              ttl: 3600
      responses:
        "200":
          description: Cache entry set.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CacheGetResponse"
              example:
                namespace: "agent-session"
                key: "last-query-result"
                value: {"result": "ok", "count": 3}
                expires_at: "2026-02-26T13:00:00.000Z"
        "400":
          description: Invalid request body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "402":
          description: x402 payment required.
        "403":
          description: Missing wallet address in payment.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      operationId: getCache
      summary: Get cache entry
      description: Returns the stored value for the given namespace and key. Returns 404 if the entry does not exist or has expired.
      security:
        - x402: []
      x-price: "$0.0001"
      parameters:
        - name: namespace
          in: path
          required: true
          description: Cache namespace.
          schema:
            type: string
          example: "agent-session"
        - name: key
          in: path
          required: true
          description: Cache key.
          schema:
            type: string
          example: "last-query-result"
      responses:
        "200":
          description: Cache entry found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CacheGetResponse"
              example:
                namespace: "agent-session"
                key: "last-query-result"
                value: {"result": "ok", "count": 3}
                expires_at: "2026-02-26T13:00:00.000Z"
        "402":
          description: x402 payment required.
        "403":
          description: Namespace belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Cache entry not found or expired.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "not_found"
                  message: "Cache entry not found"

    delete:
      operationId: deleteCache
      summary: Delete cache entry
      description: Deletes the cache entry for the given namespace and key. Caller must own the namespace.
      security:
        - x402: []
      x-price: "$0.0001"
      parameters:
        - name: namespace
          in: path
          required: true
          description: Cache namespace.
          schema:
            type: string
          example: "agent-session"
        - name: key
          in: path
          required: true
          description: Cache key.
          schema:
            type: string
          example: "last-query-result"
      responses:
        "200":
          description: Cache entry deleted.
          content:
            application/json:
              schema:
                type: object
              example: {}
        "402":
          description: x402 payment required.
        "403":
          description: Namespace belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Cache entry not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
