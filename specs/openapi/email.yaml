openapi: 3.1.0

info:
  title: email.prim.sh API
  version: 1.0.0
  description: |
    Disposable and custom-domain email for agents. Receive, send, and manage mailboxes with x402 payment (USDC on Base).

    ## Authentication

    All endpoints except `GET /` and `GET /llms.txt` require x402 payment. The flow:
    1. Make the request — server responds with `402 Payment Required` and a payment challenge.
    2. Sign the EIP-3009 payment authorization with your wallet.
    3. Retry the request with the `Payment-Signature` header set to the signed authorization.

    The wallet address extracted from the payment signature becomes the caller identity (owner of mailboxes).

    ## Limits (beta)

    - Mailboxes are ephemeral by default (TTL-based)
    - Custom domains require DNS verification

servers:
  - url: https://email.prim.sh

security:
  - x402: []

components:
  securitySchemes:
    x402:
      type: apiKey
      in: header
      name: Payment-Signature
      description: |
        EIP-3009 signed payment authorization. Server issues a 402 challenge; client signs and retries.
        See https://prim.sh/pay for the full x402 payment flow.

  schemas:
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              enum:
                - not_found
                - forbidden
                - invalid_request
                - stalwart_error
                - conflict
                - username_taken
                - jmap_error
                - expired
              description: Machine-readable error code.
            message:
              type: string
              description: Human-readable error message.

    EmailAddress:
      type: object
      required: [name, email]
      properties:
        name:
          type: ["string", "null"]
          description: Display name, or null if not set.
          example: "Alice Agent"
        email:
          type: string
          format: email
          description: Email address.
          example: "alice@example.com"

    MailboxResponse:
      type: object
      required: [id, address, username, domain, status, created_at, expires_at]
      properties:
        id:
          type: string
          description: Unique mailbox identifier (UUID).
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
        address:
          type: string
          description: Full email address for this mailbox.
          example: "agent42@mail.prim.sh"
        username:
          type: string
          description: Local part of the email address.
          example: "agent42"
        domain:
          type: string
          description: Domain of the email address.
          example: "mail.prim.sh"
        status:
          type: string
          enum: [active, expired, deleted]
          description: Current mailbox status.
          example: "active"
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp of mailbox creation.
          example: "2026-02-26T12:00:00.000Z"
        expires_at:
          type: ["string", "null"]
          format: date-time
          description: ISO 8601 expiry timestamp, or null if the mailbox does not expire.
          example: "2026-03-05T12:00:00.000Z"

    MailboxListResponse:
      type: object
      required: [mailboxes, total, page, per_page]
      properties:
        mailboxes:
          type: array
          items:
            $ref: "#/components/schemas/MailboxResponse"
        total:
          type: integer
          description: Total number of mailboxes for this wallet.
          example: 2
        page:
          type: integer
          description: Current page number.
          example: 1
        per_page:
          type: integer
          description: Number of items per page.
          example: 20

    EmailMessage:
      type: object
      required: [id, from, to, subject, received_at, size, has_attachment, preview]
      properties:
        id:
          type: string
          description: Message ID (JMAP object ID).
          example: "msg_abc123"
        from:
          $ref: "#/components/schemas/EmailAddress"
        to:
          type: array
          items:
            $ref: "#/components/schemas/EmailAddress"
        subject:
          type: string
          description: Email subject line.
          example: "Your API key is ready"
        received_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the message was received.
          example: "2026-02-26T12:05:00.000Z"
        size:
          type: integer
          description: Message size in bytes.
          example: 4096
        has_attachment:
          type: boolean
          description: Whether the message has attachments.
          example: false
        preview:
          type: string
          description: Short plain-text preview of the message body.
          example: "Your API key is: sk-abc123..."

    EmailDetail:
      allOf:
        - $ref: "#/components/schemas/EmailMessage"
        - type: object
          required: [cc, text_body, html_body]
          properties:
            cc:
              type: array
              items:
                $ref: "#/components/schemas/EmailAddress"
              description: CC recipients.
            text_body:
              type: ["string", "null"]
              description: Plain-text body, or null if not present.
              example: "Your API key is: sk-abc123. Keep it secret."
            html_body:
              type: ["string", "null"]
              description: HTML body, or null if not present.
              example: "<p>Your API key is: <code>sk-abc123</code>.</p>"

    EmailListResponse:
      type: object
      required: [messages, total, position]
      properties:
        messages:
          type: array
          items:
            $ref: "#/components/schemas/EmailMessage"
        total:
          type: integer
          description: Total number of messages in this mailbox.
          example: 5
        position:
          type: integer
          description: Zero-based position of the first result in the full list.
          example: 0

    WebhookResponse:
      type: object
      required: [id, url, events, status, created_at]
      properties:
        id:
          type: string
          description: Webhook ID (UUID).
          example: "wh_abc123"
        url:
          type: string
          format: uri
          description: Destination URL for webhook events.
          example: "https://myagent.example.com/hooks/email"
        events:
          type: array
          items:
            type: string
          description: Event types this webhook listens for.
          example: ["message.received"]
        status:
          type: string
          description: Webhook status.
          example: "active"
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp of webhook registration.
          example: "2026-02-26T12:00:00.000Z"

    WebhookListResponse:
      type: object
      required: [webhooks, total]
      properties:
        webhooks:
          type: array
          items:
            $ref: "#/components/schemas/WebhookResponse"
        total:
          type: integer
          description: Total number of webhooks for this mailbox.
          example: 1

    DnsRecord:
      type: object
      required: [type, name, content]
      properties:
        type:
          type: string
          description: DNS record type (e.g. MX, TXT, CNAME).
          example: "TXT"
        name:
          type: string
          description: DNS record name (host).
          example: "_dmarc.example.com"
        content:
          type: string
          description: DNS record value.
          example: "v=DMARC1; p=none;"
        priority:
          type: integer
          description: MX record priority (only for MX records).
          example: 10

    DomainResponse:
      type: object
      required: [id, domain, status, owner_wallet, created_at, verified_at, required_records]
      properties:
        id:
          type: string
          description: Domain ID (UUID).
          example: "dom_abc123"
        domain:
          type: string
          description: Registered domain name.
          example: "example.com"
        status:
          type: string
          description: Verification status of the domain.
          example: "pending"
        owner_wallet:
          type: string
          pattern: "^0x[a-fA-F0-9]{40}$"
          description: Ethereum address of the wallet that registered this domain.
          example: "0xAbCd1234567890abcdef1234567890abCDEF1234"
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp of domain registration.
          example: "2026-02-26T12:00:00.000Z"
        verified_at:
          type: ["string", "null"]
          format: date-time
          description: ISO 8601 timestamp of domain verification, or null if not yet verified.
          example: null
        required_records:
          type: array
          items:
            $ref: "#/components/schemas/DnsRecord"
          description: DNS records you must add to your domain for verification.
        dkim_records:
          type: array
          items:
            $ref: "#/components/schemas/DnsRecord"
          description: DKIM records to add after verification. Only present for verified domains.

    DomainListResponse:
      type: object
      required: [domains, total, page, per_page]
      properties:
        domains:
          type: array
          items:
            $ref: "#/components/schemas/DomainResponse"
        total:
          type: integer
          description: Total number of domains registered by this wallet.
          example: 1
        page:
          type: integer
          description: Current page number.
          example: 1
        per_page:
          type: integer
          description: Number of items per page.
          example: 20

    VerificationResult:
      type: object
      required: [type, name, expected, found, pass]
      properties:
        type:
          type: string
          description: DNS record type checked.
          example: "TXT"
        name:
          type: string
          description: DNS name checked.
          example: "_dmarc.example.com"
        expected:
          type: string
          description: Expected DNS record value.
          example: "v=spf1 include:mail.prim.sh ~all"
        found:
          type: ["string", "null"]
          description: Actual DNS record value found, or null if not present.
          example: "v=spf1 include:mail.prim.sh ~all"
        pass:
          type: boolean
          description: Whether the check passed.
          example: true

    VerifyDomainResponse:
      type: object
      required: [id, domain, status, verified_at]
      properties:
        id:
          type: string
          description: Domain ID (UUID).
          example: "dom_abc123"
        domain:
          type: string
          description: Domain name.
          example: "example.com"
        status:
          type: string
          description: Verification status after the check.
          example: "verified"
        verified_at:
          type: ["string", "null"]
          format: date-time
          description: ISO 8601 timestamp of successful verification, or null if still pending.
          example: "2026-02-26T12:30:00.000Z"
        verification_results:
          type: array
          items:
            $ref: "#/components/schemas/VerificationResult"
          description: Per-record verification results. Present when status is not already verified.
        dkim_records:
          type: array
          items:
            $ref: "#/components/schemas/DnsRecord"
          description: DKIM records to add now that the domain is verified. Present on successful verification.

paths:
  /:
    get:
      operationId: healthCheck
      summary: Health check
      description: Returns service status. Free — no x402 payment required.
      security: []
      responses:
        "200":
          description: Service is running.
          content:
            application/json:
              schema:
                type: object
                required: [service, status]
                properties:
                  service:
                    type: string
                    example: "email.sh"
                  status:
                    type: string
                    example: "ok"
              example:
                service: "email.sh"
                status: "ok"

  /llms.txt:
    get:
      operationId: getLlmsTxt
      summary: Machine-readable primitive catalog
      description: Returns a plain-text description of this primitive for LLM consumption. Free — no x402 payment required.
      security: []
      responses:
        "200":
          description: LLM-readable catalog entry.
          content:
            text/plain:
              schema:
                type: string

  /v1/mailboxes:
    post:
      operationId: createMailbox
      summary: Create a mailbox
      description: |
        Creates a new email mailbox owned by the paying wallet address.

        If `username` is omitted, a random username is generated. If `domain` is omitted, the default shared domain is used.
        If `ttl_ms` is omitted, the mailbox uses the default TTL (7 days).
      security:
        - x402: []
      x-price: "$0.05"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: Desired local part of the email address. Generated randomly if omitted.
                  example: "agent42"
                domain:
                  type: string
                  description: Email domain to use. Must be a verified custom domain or the shared default domain.
                  example: "mail.prim.sh"
                ttl_ms:
                  type: integer
                  description: Mailbox lifetime in milliseconds. Defaults to 7 days (604800000). Pass null for no expiry.
                  example: 604800000
            example:
              username: "agent42"
              domain: "mail.prim.sh"
              ttl_ms: 604800000
      responses:
        "201":
          description: Mailbox created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MailboxResponse"
              example:
                id: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
                address: "agent42@mail.prim.sh"
                username: "agent42"
                domain: "mail.prim.sh"
                status: "active"
                created_at: "2026-02-26T12:00:00.000Z"
                expires_at: "2026-03-05T12:00:00.000Z"
        "400":
          description: Invalid username or domain.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalid_username:
                  value:
                    error:
                      code: "invalid_request"
                      message: "Username contains invalid characters"
                invalid_domain:
                  value:
                    error:
                      code: "invalid_request"
                      message: "Domain is not registered or not verified"
        "402":
          description: x402 payment required.
        "409":
          description: Username already taken on this domain.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "username_taken"
                  message: "Username 'agent42' is already taken on domain 'mail.prim.sh'"
        "502":
          description: Upstream Stalwart mail server error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "stalwart_error"
                  message: "Failed to create mailbox in Stalwart"

    get:
      operationId: listMailboxes
      summary: List mailboxes
      description: |
        Returns all mailboxes owned by the paying wallet address.

        Pagination is page-based. Default page size is 20, maximum is 100.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: limit
          in: query
          description: Number of mailboxes per page (1–100, default 20).
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: page
          in: query
          description: Page number (1-based, default 1).
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
      responses:
        "200":
          description: List of mailboxes.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MailboxListResponse"
              example:
                mailboxes:
                  - id: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
                    address: "agent42@mail.prim.sh"
                    username: "agent42"
                    domain: "mail.prim.sh"
                    status: "active"
                    created_at: "2026-02-26T12:00:00.000Z"
                    expires_at: "2026-03-05T12:00:00.000Z"
                total: 1
                page: 1
                per_page: 20
        "402":
          description: x402 payment required.
        "403":
          description: Missing wallet address in payment.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/mailboxes/{id}:
    get:
      operationId: getMailbox
      summary: Get mailbox details
      description: Returns details for a single mailbox. Caller must own the mailbox.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Mailbox details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MailboxResponse"
              example:
                id: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
                address: "agent42@mail.prim.sh"
                username: "agent42"
                domain: "mail.prim.sh"
                status: "active"
                created_at: "2026-02-26T12:00:00.000Z"
                expires_at: "2026-03-05T12:00:00.000Z"
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "forbidden"
                  message: "Mailbox belongs to a different wallet"
        "404":
          description: Mailbox not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "not_found"
                  message: "Mailbox not found"

    delete:
      operationId: deleteMailbox
      summary: Delete a mailbox
      description: Permanently deletes a mailbox and all its messages. Caller must own the mailbox.
      security:
        - x402: []
      x-price: "$0.01"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Mailbox deleted.
          content:
            application/json:
              schema:
                type: object
                required: [id, deleted]
                properties:
                  id:
                    type: string
                    example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
                  deleted:
                    type: boolean
                    enum: [true]
                    example: true
              example:
                id: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
                deleted: true
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Mailbox not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Upstream Stalwart error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/mailboxes/{id}/renew:
    post:
      operationId: renewMailbox
      summary: Renew mailbox TTL
      description: Extends the expiry time of a mailbox. Caller must own the mailbox.
      security:
        - x402: []
      x-price: "$0.01"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                ttl_ms:
                  type: integer
                  description: Additional milliseconds to extend the mailbox TTL. Defaults to 7 days (604800000).
                  example: 604800000
            example:
              ttl_ms: 604800000
      responses:
        "200":
          description: Mailbox renewed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MailboxResponse"
              example:
                id: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
                address: "agent42@mail.prim.sh"
                username: "agent42"
                domain: "mail.prim.sh"
                status: "active"
                created_at: "2026-02-26T12:00:00.000Z"
                expires_at: "2026-03-12T12:00:00.000Z"
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Mailbox not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/mailboxes/{id}/messages:
    get:
      operationId: listMessages
      summary: List messages in a mailbox
      description: |
        Returns messages in a mailbox, newest first. Caller must own the mailbox.

        Pagination is position-based (JMAP-style). Use the `position` field in the response to paginate.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
        - name: limit
          in: query
          description: Maximum number of messages to return (1–100, default 20).
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: position
          in: query
          description: Zero-based position offset to start from (default 0).
          schema:
            type: integer
            minimum: 0
            default: 0
          example: 0
      responses:
        "200":
          description: List of messages.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmailListResponse"
              example:
                messages:
                  - id: "msg_abc123"
                    from:
                      name: "GitHub"
                      email: "noreply@github.com"
                    to:
                      - name: null
                        email: "agent42@mail.prim.sh"
                    subject: "Your verification code is 482910"
                    received_at: "2026-02-26T12:05:00.000Z"
                    size: 4096
                    has_attachment: false
                    preview: "Your one-time verification code is 482910. It expires in 10 minutes."
                total: 1
                position: 0
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Mailbox not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "410":
          description: Mailbox has expired.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "expired"
                  message: "Mailbox has expired"

  /v1/mailboxes/{id}/messages/{msgId}:
    get:
      operationId: getMessage
      summary: Get message detail
      description: Returns the full content of a single message including body. Caller must own the mailbox.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
        - name: msgId
          in: path
          required: true
          description: Message ID.
          schema:
            type: string
          example: "msg_abc123"
      responses:
        "200":
          description: Full message detail with body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmailDetail"
              example:
                id: "msg_abc123"
                from:
                  name: "GitHub"
                  email: "noreply@github.com"
                to:
                  - name: null
                    email: "agent42@mail.prim.sh"
                subject: "Your verification code is 482910"
                received_at: "2026-02-26T12:05:00.000Z"
                size: 4096
                has_attachment: false
                preview: "Your one-time verification code is 482910."
                cc: []
                text_body: "Your one-time verification code is 482910. It expires in 10 minutes."
                html_body: "<p>Your one-time verification code is <strong>482910</strong>.</p>"
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Mailbox or message not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/mailboxes/{id}/send:
    post:
      operationId: sendMessage
      summary: Send email from a mailbox
      description: |
        Sends an outbound email from the mailbox address. Caller must own the mailbox.

        Either `body` (plain text) or `html` must be provided (or both).
      security:
        - x402: []
      x-price: "$0.01"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [to, subject]
              properties:
                to:
                  type: string
                  format: email
                  description: Recipient email address.
                  example: "user@example.com"
                subject:
                  type: string
                  description: Email subject line.
                  example: "Hello from my agent"
                body:
                  type: string
                  description: Plain-text message body.
                  example: "This email was sent by an agent via email.prim.sh"
                html:
                  type: string
                  description: HTML message body. Can be provided alongside `body` for multipart messages.
                  example: "<p>This email was sent by an agent.</p>"
                cc:
                  type: string
                  format: email
                  description: CC recipient email address.
                  example: "other@example.com"
                bcc:
                  type: string
                  format: email
                  description: BCC recipient email address.
                  example: "blind@example.com"
            example:
              to: "user@example.com"
              subject: "Hello from my agent"
              body: "This email was sent by an agent via email.prim.sh"
      responses:
        "200":
          description: Message sent.
          content:
            application/json:
              schema:
                type: object
                required: [message_id, status]
                properties:
                  message_id:
                    type: string
                    description: Server-assigned message ID.
                    example: "msg_sent_xyz789"
                  status:
                    type: string
                    enum: [sent]
                    example: "sent"
              example:
                message_id: "msg_sent_xyz789"
                status: "sent"
        "400":
          description: Missing required fields or invalid recipient.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "invalid_request"
                  message: "Either 'body' or 'html' must be provided"
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Mailbox not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Upstream Stalwart JMAP error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "jmap_error"
                  message: "Failed to submit message via JMAP"

  /v1/mailboxes/{id}/webhooks:
    post:
      operationId: registerWebhook
      summary: Register a webhook
      description: |
        Registers a webhook URL to receive notifications for this mailbox. Caller must own the mailbox.

        Supported events: `message.received`. If `events` is omitted, all events are sent.
        If `secret` is provided, each webhook delivery includes an `X-Prim-Signature` header (HMAC-SHA256).
      security:
        - x402: []
      x-price: "$0.01"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url:
                  type: string
                  format: uri
                  description: HTTPS URL to receive webhook events.
                  example: "https://myagent.example.com/hooks/email"
                secret:
                  type: string
                  description: Optional signing secret. Used to generate HMAC-SHA256 signatures.
                  example: "whsec_abc123"
                events:
                  type: array
                  items:
                    type: string
                  description: Event types to subscribe to. Defaults to all events.
                  example: ["message.received"]
            example:
              url: "https://myagent.example.com/hooks/email"
              secret: "whsec_abc123"
              events: ["message.received"]
      responses:
        "201":
          description: Webhook registered.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookResponse"
              example:
                id: "wh_abc123"
                url: "https://myagent.example.com/hooks/email"
                events: ["message.received"]
                status: "active"
                created_at: "2026-02-26T12:00:00.000Z"
        "400":
          description: Invalid webhook URL or event type.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "invalid_request"
                  message: "Webhook URL must use HTTPS"
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Mailbox not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: A webhook for this URL already exists on this mailbox.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "conflict"
                  message: "Webhook for this URL already exists"

    get:
      operationId: listWebhooks
      summary: List webhooks for a mailbox
      description: Returns all registered webhooks for a mailbox. Caller must own the mailbox.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: List of webhooks.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookListResponse"
              example:
                webhooks:
                  - id: "wh_abc123"
                    url: "https://myagent.example.com/hooks/email"
                    events: ["message.received"]
                    status: "active"
                    created_at: "2026-02-26T12:00:00.000Z"
                total: 1
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Mailbox not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/mailboxes/{id}/webhooks/{whId}:
    delete:
      operationId: deleteWebhook
      summary: Delete a webhook
      description: Removes a webhook registration from a mailbox. Caller must own the mailbox.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Mailbox ID.
          schema:
            type: string
          example: "m1a2b3c4-d5e6-7890-abcd-ef1234567890"
        - name: whId
          in: path
          required: true
          description: Webhook ID.
          schema:
            type: string
          example: "wh_abc123"
      responses:
        "200":
          description: Webhook deleted.
          content:
            application/json:
              schema:
                type: object
                required: [id, deleted]
                properties:
                  id:
                    type: string
                    example: "wh_abc123"
                  deleted:
                    type: boolean
                    enum: [true]
                    example: true
              example:
                id: "wh_abc123"
                deleted: true
        "402":
          description: x402 payment required.
        "403":
          description: Mailbox belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Mailbox or webhook not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/domains:
    post:
      operationId: registerDomain
      summary: Register an email domain
      description: |
        Registers a custom domain for use with email.prim.sh mailboxes.

        After registration, add the `required_records` DNS entries to your domain, then call `POST /v1/domains/{id}/verify` to complete verification.
      security:
        - x402: []
      x-price: "$0.05"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [domain]
              properties:
                domain:
                  type: string
                  description: Domain name to register (e.g. "example.com").
                  example: "example.com"
            example:
              domain: "example.com"
      responses:
        "201":
          description: Domain registered. Add the required_records to your DNS, then verify.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DomainResponse"
              example:
                id: "dom_abc123"
                domain: "example.com"
                status: "pending"
                owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                created_at: "2026-02-26T12:00:00.000Z"
                verified_at: null
                required_records:
                  - type: "MX"
                    name: "example.com"
                    content: "mail.prim.sh"
                    priority: 10
                  - type: "TXT"
                    name: "example.com"
                    content: "v=spf1 include:mail.prim.sh ~all"
        "400":
          description: Invalid domain name.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "invalid_request"
                  message: "Invalid domain name"
        "402":
          description: x402 payment required.
        "409":
          description: Domain already registered (by any wallet).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error:
                  code: "conflict"
                  message: "Domain 'example.com' is already registered"
        "502":
          description: Upstream Stalwart error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      operationId: listDomains
      summary: List registered domains
      description: Returns all domains registered by the paying wallet address.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: limit
          in: query
          description: Number of domains per page (1–100, default 20).
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: page
          in: query
          description: Page number (1-based, default 1).
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
      responses:
        "200":
          description: List of domains.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DomainListResponse"
              example:
                domains:
                  - id: "dom_abc123"
                    domain: "example.com"
                    status: "verified"
                    owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                    created_at: "2026-02-26T12:00:00.000Z"
                    verified_at: "2026-02-26T12:30:00.000Z"
                    required_records: []
                total: 1
                page: 1
                per_page: 20
        "402":
          description: x402 payment required.
        "403":
          description: Missing wallet address in payment.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/domains/{id}:
    get:
      operationId: getDomain
      summary: Get domain details
      description: Returns details for a single domain. Caller must own the domain.
      security:
        - x402: []
      x-price: "$0.001"
      parameters:
        - name: id
          in: path
          required: true
          description: Domain ID.
          schema:
            type: string
          example: "dom_abc123"
      responses:
        "200":
          description: Domain details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DomainResponse"
              example:
                id: "dom_abc123"
                domain: "example.com"
                status: "pending"
                owner_wallet: "0xAbCd1234567890abcdef1234567890abCDEF1234"
                created_at: "2026-02-26T12:00:00.000Z"
                verified_at: null
                required_records:
                  - type: "MX"
                    name: "example.com"
                    content: "mail.prim.sh"
                    priority: 10
        "402":
          description: x402 payment required.
        "403":
          description: Domain belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Domain not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      operationId: deleteDomain
      summary: Delete a domain
      description: |
        Removes a custom domain registration. Any mailboxes using this domain will stop receiving mail.

        If mailboxes exist on this domain, the response includes a `warning` field.
      security:
        - x402: []
      x-price: "$0.01"
      parameters:
        - name: id
          in: path
          required: true
          description: Domain ID.
          schema:
            type: string
          example: "dom_abc123"
      responses:
        "200":
          description: Domain deleted.
          content:
            application/json:
              schema:
                type: object
                required: [id, deleted]
                properties:
                  id:
                    type: string
                    example: "dom_abc123"
                  deleted:
                    type: boolean
                    enum: [true]
                    example: true
                  warning:
                    type: string
                    description: Present if active mailboxes existed on this domain.
                    example: "3 mailboxes on this domain will no longer receive mail"
              examples:
                simple:
                  value:
                    id: "dom_abc123"
                    deleted: true
                with_warning:
                  value:
                    id: "dom_abc123"
                    deleted: true
                    warning: "3 mailboxes on this domain will no longer receive mail"
        "402":
          description: x402 payment required.
        "403":
          description: Domain belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Domain not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: Upstream Stalwart error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/domains/{id}/verify:
    post:
      operationId: verifyDomain
      summary: Verify domain ownership
      description: |
        Checks that the required DNS records are present and live for this domain.
        Call this after adding the `required_records` returned from `POST /v1/domains`.

        On success, the domain status changes to `verified` and `dkim_records` are returned for you to add.
      security:
        - x402: []
      x-price: "$0.01"
      parameters:
        - name: id
          in: path
          required: true
          description: Domain ID.
          schema:
            type: string
          example: "dom_abc123"
      responses:
        "200":
          description: Verification result.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyDomainResponse"
              examples:
                verified:
                  summary: All checks passed
                  value:
                    id: "dom_abc123"
                    domain: "example.com"
                    status: "verified"
                    verified_at: "2026-02-26T12:30:00.000Z"
                    dkim_records:
                      - type: "TXT"
                        name: "mail._domainkey.example.com"
                        content: "v=DKIM1; k=rsa; p=MIGf..."
                pending:
                  summary: Some checks failed
                  value:
                    id: "dom_abc123"
                    domain: "example.com"
                    status: "pending"
                    verified_at: null
                    verification_results:
                      - type: "MX"
                        name: "example.com"
                        expected: "mail.prim.sh"
                        found: null
                        pass: false
        "402":
          description: x402 payment required.
        "403":
          description: Domain belongs to a different wallet.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Domain not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
