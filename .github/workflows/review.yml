name: Code Review

on:
  workflow_dispatch: # disabled — not producing signal, re-enable when needed

concurrency:
  group: review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  review:
    name: Claude review
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.actor != 'claude-code[bot]' && github.actor != 'prim-ci[bot]')
      || (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude'))
    timeout-minutes: 10

    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PRIM_CI_APP_ID }}
          private-key: ${{ secrets.PRIM_CI_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this PR for bugs, security issues, and architectural problems.

            ## Process

            1. Run `gh pr diff ${{ github.event.pull_request.number }}` to read the diff FIRST
            2. Only open files if the diff reveals something suspicious that needs more context
            3. If nothing is wrong, stop immediately — do not explore the codebase

            ## What to look for

            - Security: hardcoded secrets, unvalidated input, missing ownership checks, injection
            - Logic bugs: incorrect x402 pricing, wrong HTTP status codes, unhandled ServiceResult errors
            - Architecture: wrong module ownership, import direction violations
            - Test gaps: new endpoints without smoke test coverage, weakened assertions

            ## What to ignore (Biome enforces these)

            Formatting, imports, naming, unused vars, explicit `any`

            ## Actions

            - If you find a fixable bug or security issue, fix it and push
            - Use conventional commit format: type(scope): subject
            - If nothing is wrong, do nothing — no LGTM comments, no praise
          claude_args: "--max-turns 10 --model claude-sonnet-4-6 --allowedTools Bash,Read,Edit,Write,Glob,Grep"
          trigger_phrase: "@claude"
