name: Deploy

# Triggers after CI passes on main, or manually via workflow_dispatch.
# Never runs concurrently — queues instead of cancelling to avoid leaving VPS
# in a partially-deployed state.
#
# Flow:
#   deploy-vps  → rsync to VPS → deploy.sh (install, build, restart)
#   deploy-site → build static dist → wrangler pages deploy
#   verify      → smoke check: fetch /_build_id.txt and confirm SHA matches
#
# ── Required GitHub secrets (production environment) ─────────────────────────
#
#   VPS_HOST        SSH user@host string, e.g. "root@<your-vps-ip>"
#   VPS_SSH_KEY     Ed25519 private key (see setup below)
#   VPS_KNOWN_HOSTS Output of: ssh-keyscan <VPS_IP>
#   CF_API_TOKEN    Cloudflare API token (Pages:Edit permission)
#   CF_ACCOUNT_ID   Cloudflare account ID
#
# ── Required GitHub repository variable ──────────────────────────────────────
#
#   PAGES_PROJECT   Cloudflare Pages project name (e.g. "prim-sh")
#
# ── One-time SSH deploy key setup ────────────────────────────────────────────
#
# 1. ssh-keygen -t ed25519 -f gha-deploy -C "gha-deploy@prim"
# 2. Install public key on VPS: ssh root@<IP> "cat >> ~/.ssh/authorized_keys" < gha-deploy.pub
# 3. ssh-keyscan <VPS_IP>  →  VPS_KNOWN_HOSTS secret
# 4. Add VPS_HOST, VPS_SSH_KEY, VPS_KNOWN_HOSTS as GitHub Actions secrets
# 5. rm gha-deploy gha-deploy.pub
#
# ─────────────────────────────────────────────────────────────────────────────

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy-vps:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_KNOWN_HOSTS: ${{ secrets.VPS_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$VPS_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "$VPS_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Rsync to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          rsync -avz --delete \
            --exclude='node_modules/' \
            --exclude='.git/' \
            --exclude='*.db' \
            --exclude='*.db-shm' \
            --exclude='*.db-wal' \
            --exclude='server.log' \
            --exclude='.env*' \
            --exclude='brand/assets/' \
            --exclude='research/' \
            --exclude='specs/' \
            --exclude='.claude/' \
            --exclude='bun.lock' \
            ./ "$VPS_HOST":/opt/prim/

      - name: Fix ownership
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: ssh "$VPS_HOST" "chown -R prim:prim /opt/prim"

      - name: Install, build, restart
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: ssh "$VPS_HOST" "bash /opt/prim/deploy/prim/deploy.sh"

  deploy-site:
    name: Deploy site → Cloudflare Pages
    runs-on: ubuntu-latest
    environment: production

    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Build static dist
        run: |
          mkdir -p site-dist
          # Copy all web-deliverable files; exclude server-side .ts/.py files
          rsync -a \
            --include='*/' \
            --include='*.html' --include='*.css' --include='*.js' \
            --include='*.jpg' --include='*.jpeg' --include='*.png' \
            --include='*.ico' --include='*.svg' --include='*.webp' \
            --include='*.txt' --include='*.json' \
            --exclude='*' \
            site/ site-dist/
          # Build ID for smoke check verification
          echo "$GITHUB_SHA" > site-dist/_build_id.txt

      - uses: cloudflare/wrangler-action@v4
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: pages deploy site-dist --project-name ${{ vars.PAGES_PROJECT }}

  verify:
    name: Smoke check
    needs: [deploy-vps, deploy-site]
    runs-on: ubuntu-latest

    steps:
      - name: Verify site build ID
        run: |
          expected="${{ github.sha }}"
          for i in $(seq 1 6); do
            actual=$(curl -sf https://prim.sh/_build_id.txt || echo "")
            if [ "$actual" = "$expected" ]; then
              echo "Build ID verified: $actual"
              exit 0
            fi
            echo "Attempt $i: got '$actual', waiting..."
            sleep 10
          done
          echo "Smoke check failed: expected $expected"
          exit 1
