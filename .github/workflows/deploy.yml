name: Deploy

# Triggers after CI passes on main, or manually via workflow_dispatch.
# Never runs concurrently — queues instead of cancelling to avoid leaving VPS
# in a partially-deployed state.
#
# ── Required GitHub secrets ──────────────────────────────────────────────────
#
#   VPS_HOST        SSH user@host string, e.g. "root@157.230.187.207"
#   VPS_SSH_KEY     Ed25519 private key (see setup below)
#   VPS_KNOWN_HOSTS Output of: ssh-keyscan <VPS_IP>
#
# ── One-time SSH deploy key setup ────────────────────────────────────────────
#
# 1. Generate a deploy-specific Ed25519 keypair (do NOT use your personal key):
#
#      ssh-keygen -t ed25519 -f gha-deploy -C "gha-deploy@prim"
#      # Creates: gha-deploy (private) and gha-deploy.pub (public)
#
# 2. Install the public key on the VPS:
#
#      ssh root@157.230.187.207 \
#        "echo '$(cat gha-deploy.pub)' >> ~/.ssh/authorized_keys"
#
#    Optional: restrict the key to only run the deploy script
#    (edit ~/.ssh/authorized_keys on the VPS and prefix the new line with):
#
#      command="/opt/prim/deploy/prim/deploy.sh",no-port-forwarding,no-x11-forwarding,no-agent-forwarding
#
# 3. Collect known_hosts entry:
#
#      ssh-keyscan 157.230.187.207
#
# 4. Add secrets in GitHub → repo Settings → Secrets and variables → Actions:
#
#      VPS_HOST        root@157.230.187.207
#      VPS_SSH_KEY     contents of ./gha-deploy (the private key file)
#      VPS_KNOWN_HOSTS output of ssh-keyscan from step 3
#
# 5. Delete the local key files:
#
#      rm gha-deploy gha-deploy.pub
#
# ── Rollback ─────────────────────────────────────────────────────────────────
#
# No automated rollback in v1. If a deploy breaks:
#   ssh root@157.230.187.207
#   git -C /opt/prim log --oneline   # find last good SHA
#   git -C /opt/prim checkout <sha>
#   bash /opt/prim/deploy/prim/deploy.sh
#
# ─────────────────────────────────────────────────────────────────────────────

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    # For workflow_run trigger: only deploy when CI succeeded.
    # workflow_dispatch has no conclusion, so the condition must allow that.
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── SSH setup ────────────────────────────────────────────────────────────
      - name: Setup SSH
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_KNOWN_HOSTS: ${{ secrets.VPS_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$VPS_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "$VPS_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # ── Rsync source ─────────────────────────────────────────────────────────
      # Excludes mirror scripts/sync-vps.sh exactly.
      - name: Rsync source to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          rsync -avz --delete \
            --exclude='node_modules/' \
            --exclude='.git/' \
            --exclude='*.db' \
            --exclude='*.db-shm' \
            --exclude='*.db-wal' \
            --exclude='server.log' \
            --exclude='.env*' \
            --exclude='brand/assets/' \
            --exclude='research/' \
            --exclude='specs/' \
            --exclude='.claude/' \
            --exclude='bun.lock' \
            ./ "$VPS_HOST":/opt/prim/

      # ── Remote deploy ─────────────────────────────────────────────────────────
      - name: Run deploy script on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh "$VPS_HOST" "bash /opt/prim/deploy/prim/deploy.sh"
