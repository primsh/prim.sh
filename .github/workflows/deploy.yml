name: Deploy

# Triggers after CI passes on main, or manually via workflow_dispatch.
# Never runs concurrently — queues instead of cancelling to avoid leaving VPS
# in a partially-deployed state.
#
# Flow: checkout → rsync to VPS → run deploy.sh (install, build, restart)
#
# ── Required GitHub secrets ──────────────────────────────────────────────────
#
#   VPS_HOST        SSH user@host string, e.g. "root@157.230.187.207"
#   VPS_SSH_KEY     Ed25519 private key (see setup below)
#   VPS_KNOWN_HOSTS Output of: ssh-keyscan <VPS_IP>
#
# ── One-time SSH deploy key setup ────────────────────────────────────────────
#
# 1. ssh-keygen -t ed25519 -f gha-deploy -C "gha-deploy@prim"
# 2. Install public key on VPS: ssh root@<IP> "cat >> ~/.ssh/authorized_keys" < gha-deploy.pub
# 3. ssh-keyscan <VPS_IP>  →  VPS_KNOWN_HOSTS secret
# 4. Add VPS_HOST, VPS_SSH_KEY, VPS_KNOWN_HOSTS as GitHub Actions secrets
# 5. rm gha-deploy gha-deploy.pub
#
# ─────────────────────────────────────────────────────────────────────────────

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_KNOWN_HOSTS: ${{ secrets.VPS_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$VPS_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "$VPS_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Rsync to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          rsync -avz --delete \
            --exclude='node_modules/' \
            --exclude='.git/' \
            --exclude='*.db' \
            --exclude='*.db-shm' \
            --exclude='*.db-wal' \
            --exclude='server.log' \
            --exclude='.env*' \
            --exclude='brand/assets/' \
            --exclude='research/' \
            --exclude='specs/' \
            --exclude='.claude/' \
            --exclude='bun.lock' \
            ./ "$VPS_HOST":/opt/prim/

      - name: Fix ownership
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: ssh "$VPS_HOST" "chown -R prim:prim /opt/prim"

      - name: Install, build, restart
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: ssh "$VPS_HOST" "bash /opt/prim/deploy/prim/deploy.sh"
