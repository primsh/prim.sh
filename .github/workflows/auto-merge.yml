name: Auto-merge PRs

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge:
    name: Enable auto-merge
    runs-on: ubuntu-latest
    # Skip PRs labeled needs-review
    if: >-
      !contains(github.event.pull_request.labels.*.name, 'needs-review')

    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PRIM_CI_APP_ID }}
          private-key: ${{ secrets.PRIM_CI_PRIVATE_KEY }}

      - name: Check for major bumps and enable auto-merge
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            core.info(`PR #${pr.number}: "${title}" by ${pr.user.login}`);

            // Detect major version bump from bot PR titles.
            // dependabot: "Bump <pkg> from X.Y.Z to A.B.C"
            // renovate:   "Update dependency <pkg> to vA.B.C"
            function isMajorBump(title) {
              const depBotMatch = title.match(/from\s+v?(\d+)\.\d+\.\d+\s+to\s+v?(\d+)\.\d+/i);
              if (depBotMatch) {
                const fromMajor = parseInt(depBotMatch[1], 10);
                const toMajor = parseInt(depBotMatch[2], 10);
                return toMajor > fromMajor;
              }
              return false;
            }

            if (isMajorBump(title)) {
              core.info('Major version bump detected â€” adding needs-review label, skipping auto-merge.');

              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'needs-review',
                });
              } catch {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'needs-review',
                  color: 'e4e669',
                  description: 'Requires human review before merging',
                });
              }

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['needs-review'],
              });

              return;
            }

            core.info('Enabling auto-merge (squash). PR will merge once all required checks pass.');

            await github.graphql(`
              mutation EnableAutoMerge($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: SQUASH
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `, {
              pullRequestId: pr.node_id,
            });
