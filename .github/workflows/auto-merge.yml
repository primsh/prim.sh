name: Auto-merge Bot PRs

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge:
    name: Auto-merge patch/minor bot PRs
    runs-on: ubuntu-latest
    # Only run for known bots
    if: |
      github.event.pull_request.user.login == 'dependabot[bot]' ||
      github.event.pull_request.user.login == 'renovate[bot]'

    steps:
      - name: Check bump type and enable auto-merge
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            const author = pr.user.login;

            core.info(`Bot PR detected: "${title}" by ${author}`);

            // Detect major version bump from PR title.
            // dependabot: "Bump <pkg> from X.Y.Z to A.B.C"
            // renovate:   "Update dependency <pkg> to vA.B.C" or "chore(deps): update <pkg> to vA.B.C"
            function isMajorBump(title) {
              // dependabot pattern: extract from/to versions
              const depBotMatch = title.match(/from\s+v?(\d+)\.\d+\.\d+\s+to\s+v?(\d+)\.\d+/i);
              if (depBotMatch) {
                const fromMajor = parseInt(depBotMatch[1], 10);
                const toMajor = parseInt(depBotMatch[2], 10);
                return toMajor > fromMajor;
              }

              // renovate pattern: look for major version in "to vX" where X is clearly a major jump
              // Without a from-version we can't know, so default to safe (don't block).
              return false;
            }

            if (isMajorBump(title)) {
              core.info('Major version bump detected — adding needs-review label, skipping auto-merge.');

              // Ensure the label exists
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'needs-review',
                });
              } catch {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'needs-review',
                  color: 'e4e669',
                  description: 'Requires human review before merging',
                });
              }

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['needs-review'],
              });

              return;
            }

            core.info('Patch/minor bump — enabling auto-merge (squash).');

            // Enable auto-merge via the GraphQL API (REST doesn't support it directly)
            await github.graphql(`
              mutation EnableAutoMerge($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: SQUASH
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `, {
              pullRequestId: pr.node_id,
            });

            core.info('Auto-merge enabled. PR will merge once all required checks pass.');
