# x402 Payment Protocol

x402 is an HTTP payment protocol built on the [HTTP 402 status code](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/402). Prim uses it as the sole authentication mechanism — no API keys, no accounts.

## How it works

Every Prim endpoint that costs money follows this flow:

```
1. Agent calls endpoint
   POST https://store.prim.sh/v1/buckets

2. Server returns 402
   HTTP/1.1 402 Payment Required
   Content-Type: application/json

   {
     "accepts": [{
       "scheme": "exact",
       "network": "eip155:84532",
       "maxAmountRequired": "1000",
       "asset": "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
       "payTo": "0xPrimTreasuryAddress",
       "extra": { "name": "USD Coin", "version": "2" }
     }]
   }

3. Agent signs EIP-3009 transferWithAuthorization
   - amount: 1000 (= $0.001 USDC, 6 decimals)
   - from: agent wallet address
   - to: Prim treasury address
   - validAfter: 0
   - validBefore: Date.now() + 60s
   - nonce: random bytes32

4. Agent retries with payment header
   POST https://store.prim.sh/v1/buckets
   X-PAYMENT: <base64-encoded payment payload>

5. Facilitator settles on-chain, server returns 201
```

The key insight: the signature is off-chain. No gas is spent by the agent. The facilitator (a Coinbase service) batches settlement on Base L2. Gas is sub-cent.

## Token and network

**Testnet (current):** Base Sepolia (`eip155:84532`), USDC at `0x036CbD53842c5426634e7929541eC2318f3dCF7e`

**Mainnet (coming):** Base (`eip155:8453`), USDC at `0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913`

## Using @primsh/x402-client

The easiest way to handle x402 in TypeScript:

```typescript
import { createPrimFetch } from "@primsh/x402-client";

const fetch402 = createPrimFetch({
  privateKey: process.env.AGENT_PRIVATE_KEY as `0x${string}`,
});

// Use like regular fetch — 402 handling is automatic
const res = await fetch402("https://store.prim.sh/v1/buckets", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ name: "my-data" }),
});
```

Install:

```bash
npm install @primsh/x402-client
# or
pnpm add @primsh/x402-client
```

## Using @x402/fetch (upstream)

Prim is compatible with the upstream [x402 client](https://www.x402.org):

```typescript
import { wrapFetchWithPayment } from "@x402/fetch";

const fetch402 = wrapFetchWithPayment(fetch, { privateKey });
```

## Manual implementation

If you're building in another language, implement this directly:

1. On any 402 response, parse the `accepts` array.
2. Pick an accepted scheme (Prim uses `"exact"`).
3. Build an EIP-3009 `transferWithAuthorization` struct:

```
struct TransferWithAuthorization {
  address from;       // your wallet
  address to;         // payTo from 402 response
  uint256 value;      // maxAmountRequired
  uint256 validAfter; // 0
  uint256 validBefore; // block.timestamp + 60
  bytes32 nonce;      // random 32 bytes
}
```

4. Sign with EIP-712 using your private key.
5. Encode the payment payload (see x402 spec) and set `X-PAYMENT` header.
6. Retry the original request.

The full x402 spec is at [x402.org](https://www.x402.org).

## Pricing

Prices are returned in the 402 response before you authorize. The `maxAmountRequired` field is in the token's base units (USDC has 6 decimals, so `1000` = $0.001).

Current pricing:

| Primitive | Operation | Price |
|-----------|-----------|-------|
| store.sh | Create/delete bucket | $0.001 |
| store.sh | Put/get/delete object | $0.001 |
| spawn.sh | Create server | $0.01 |
| spawn.sh | Server action (start/stop/reboot) | $0.005 |
| search.sh | Web/news search | $0.005 |
| search.sh | URL extraction | $0.003 |
| wallet.sh | Register wallet | Free |
| faucet.sh | USDC/ETH drip | Free |

Prices may change. Always use the value from the 402 response, not hardcoded amounts.
