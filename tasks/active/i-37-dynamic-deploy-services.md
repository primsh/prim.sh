# I-37: Dynamic deploy.sh SERVICES â€” read prim.yaml status:live instead of hardcoded array

## Context

Four prims (token, mem, domain, track) have full deploy artifacts (systemd units, Caddy fragments, env templates) but are missing from auto-restart during deploys. The root cause is that their `prim.yaml` `status` is `building`, not `live`.

### How the pipeline works today

1. Each prim declares `status` in `packages/<id>/prim.yaml` (`idea | planning | building | testing | live`).
2. `scripts/lib/primitives.ts` exports `deployed()` which filters `status === "live"`.
3. `scripts/gen-prims.ts` calls `deployed(prims)` to generate:
   - `SERVICES=(...)` array in `deploy/prim/deploy.sh` (marker: `BEGIN:PRIM:SERVICES`)
   - `SERVICES=(...)` array in `deploy/prim/setup.sh` (same marker)
   - `ENDPOINTS=(...)` array in `deploy/prim/healthcheck.sh` (marker: `BEGIN:PRIM:ENDPOINTS`)
4. Running `pnpm gen:prims` regenerates these arrays. `pnpm gen:check` verifies freshness in CI.

### Current state

| Prim | prim.yaml status | In SERVICES array | Systemd unit exists | Caddy block exists |
|------|------------------|-------------------|--------------------|--------------------|
| wallet | live | Yes | Yes | Yes |
| faucet | live | Yes | Yes | Yes |
| spawn | live | Yes | Yes | Yes |
| store | live | Yes | Yes | Yes |
| email | live | Yes | Yes | Yes |
| search | live | Yes | Yes | Yes |
| infer | live | Yes | Yes | Yes |
| token | building | **No** | Yes | Yes |
| mem | building | **No** | Yes | Yes |
| domain | building | **No** | Yes | Yes |
| track | building | **No** | Yes | Yes |

The systemd units and Caddy blocks were created by `deploy-prim.ts` (per-prim artifact generator), which does NOT filter by status. But the SERVICES/ENDPOINTS arrays in the deploy scripts are generated by `gen-prims.ts`, which only includes `status === "live"` prims. So when deploy.sh runs, it restarts only the 7 live prims and skips the 4 building ones.

### Why not just flip status to live?

These prims may genuinely not be ready for `live` status (gate checks, smoke tests, approval). The fix is to either:
- (A) Promote them to `live` when they pass gates, then run `pnpm gen:prims` -- the existing pipeline handles it.
- (B) Change the deploy filter to include `building` and `testing` in addition to `live`.

Option A is the correct approach -- the pipeline already works as designed. The "missing from auto-restart" problem is a status hygiene issue, not a codegen bug.

However, there IS a secondary issue: `setup.sh` line 209 has a hardcoded service list in a log message that will always drift. That should be generated or derived from `$SERVICES`.

## Changes

### 1. Promote the 4 prims to `live` (or `testing`)

**Files:** `packages/token/prim.yaml`, `packages/mem/prim.yaml`, `packages/domain/prim.yaml`, `packages/track/prim.yaml`

Each prim needs its `status` field changed to `live` (if deployed and passing gates) or `testing` (if deployed but not yet gate-approved). The decision per prim:

- Evaluate whether each prim passes `bun scripts/gate-check.ts <id> live`. If it does, set `status: live`. If not, set `status: testing` and file a follow-up task to close the remaining gate failures.

After updating statuses, run `pnpm gen:prims` to regenerate SERVICES/ENDPOINTS arrays.

### 2. Fix hardcoded service list in setup.sh log message

**File:** `deploy/prim/setup.sh`

Line 209 has:
```
log "       systemctl start prim-wallet prim-store ... caddy"
```

Replace the hardcoded list with a dynamic expansion of `$SERVICES`:

```bash
log "       systemctl start ${SERVICES[*]/#/prim-} caddy"
```

This uses bash parameter expansion to prepend `prim-` to each element. The log message will stay in sync with the generated SERVICES array automatically.

### 3. Consider adding `testing` to the deploy filter (optional)

**File:** `scripts/lib/primitives.ts` (the `deployed()` function)

If the decision is that prims at `testing` status should also be deployed to VPS for integration testing, broaden the filter:

```ts
return prims.filter((p) => p.status === "live" || p.status === "testing");
```

This is a design decision, not a bug fix. If `testing` means "on VPS but not publicly advertised," this makes sense. If `testing` means "local dev only," leave `deployed()` as-is and only promote to `live` when ready.

## Verification

1. After promoting statuses and running `pnpm gen:prims`:
   - `deploy/prim/deploy.sh` SERVICES array includes all promoted prims
   - `deploy/prim/setup.sh` SERVICES array matches
   - `deploy/prim/healthcheck.sh` ENDPOINTS array includes the new endpoints
2. `pnpm gen:check` passes (no stale markers)
3. On VPS after deploy: `systemctl status prim-{token,mem,domain,track}` shows active

## Before closing

- [ ] Run `pnpm gen:check` (all generated files are fresh)
- [ ] Verify the 4 prims appear in SERVICES arrays in deploy.sh and setup.sh
- [ ] Verify the 4 endpoints appear in ENDPOINTS array in healthcheck.sh
- [ ] Confirm setup.sh line 209 log message no longer has a hardcoded list
- [ ] If `deployed()` filter was broadened, verify no unintended prims leak into deploy scripts (check that `building` and `idea` prims are still excluded)
