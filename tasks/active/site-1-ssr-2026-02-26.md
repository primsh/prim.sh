# SITE-1: SSR Site — Template + YAML → serve.ts

**Date:** 2026-02-26
**Status:** pending
**Scope:** `site/serve.ts`, `site/template.ts`, `packages/*/prim.yaml` (content fields), `site/*/index.html` (delete built ones), `deploy/prim/Caddyfile`, `deploy/prim/prim-site.service`

## Problem

31 HTML files share ~90% identical CSS and structure. The only per-page differences are: accent color, name, tagline, curl examples, and section content. The CSS has already drifted (spawn uses `--green`/`--green-dim` instead of `--accent`). Updating any shared element (CSS, footer, nav) requires editing 27 files.

## Goal

- Single HTML template, per-prim YAML defines all content
- `serve.ts` renders pages on request from template + YAML
- Delete per-prim `index.html` files for built primitives
- Cloudflare caches rendered HTML at edge — same speed as static

## Relationship to I-1

I-1 adds `prim.yaml` per package with `status`, `env`, and `pricing` fields, and a codegen script that injects markers into existing HTML. **SITE-1 supersedes the per-page marker injection** (STATUS and PRICING sections) from I-1 — template handles those directly from YAML. I-1's other targets (index.html cards, llms.txt, README, pre-deploy.ts) are unaffected.

Coordinate: run I-1 first or in parallel. SITE-1 picks up the existing prim.yaml schema and extends it.

## Architecture

```
GET prim.sh/wallet
  ↓
serve.ts
  reads site/wallet/prim.yaml  (or packages/wallet/prim.yaml — package wins)
  renders template(yaml)
  → HTML string
  → response with Cache-Control: public, max-age=300, s-maxage=300
  ↓
Cloudflare caches for 300s, serves from edge on subsequent requests
```

No generated files. No HTML files for built primitives in git. YAML is the only source.

## Deployment Change

Currently: Cloudflare Pages serves static HTML from `site/`.
After: `prim-site` systemd service on the VPS (port 3000), Caddy proxies `prim.sh` → `localhost:3000`, Cloudflare proxies with caching.

This is consistent with how all other primitives are deployed. Cloudflare edge caching makes it as fast as Pages for cached responses.

## YAML Schema (additions to I-1's schema)

Per-prim YAML at `packages/<id>/prim.yaml` (or `site/<id>/prim.yaml` for unbuilt):

I-1's current schema: `id, name, endpoint, status, type, card_class, description, port, order, phantom, env, pricing`. Note: no `accent` or `wraps` fields exist yet in I-1's schema.

**Phase 1 of SITE-1 must add these fields to each prim.yaml** (they are not inherited from I-1):

```
# add to I-1's existing fields:
accent:       "#8BC34A"           # hex value — source of truth for --accent CSS var
accent_dim:   "#6a9e2a"           # --accent-dim
accent_glow:  "rgba(139,195,74,0.08)"  # --accent-glow

# new content fields for SITE-1:
tagline:     "Wallets for agents."
sub:         "Create, fund, and spend..."
hero_badges: ["Base USDC", "x402 native", "Multi-wallet"]
hero_example: |
  # Create a wallet
  $ curl -X POST https://wallet.prim.sh/v1/wallets \
      -H "X-402-Payment: $TOKEN"

  { "address": "0xabc...", ... }

cta:
  headline: "Wallets are an API call."
  sub:      "Agents don't KYC. They generate keys."

sections: [...]   # ordered list of typed section blocks
```

**`card_class` → `accent` migration**: I-1 uses `card_class: green` for the homepage grid. SITE-1 uses hex `accent` values directly. The template derives `--accent` from the hex field — no class mapping needed. When populating Phase 1 YAMLs, extract hex values from each page's existing `:root { --accent: ... }` declaration. The `card_class` field stays for I-1's homepage codegen; it is not used by the template.

### Section types

All sections have `type` and `title` (with optional `highlight` for the colored word in `h2`).

**`cards`** — grid of feature cards:
```yaml
- type: cards
  title: "What agents"
  highlight: "use it for"
  items:
    - title: "Service payments"
      body: "Pay for spawn, relay, infer..."
    - title: "Autonomous budgeting"
      body: "..."
```

**`code`** — pre block with syntax-highlighted lines:
```yaml
- type: code
  title: "API"
  highlight: "reference"
  lines:
    - {text: "POST   /v1/wallets", class: "a", comment: "Create wallet"}
    - {text: "GET    /v1/wallets", class: "a", comment: "List wallets"}
```
Shorthand: `raw: |` for a freeform pre block (no per-line structure).

**`flow`** — numbered horizontal flow:
```yaml
- type: flow
  title: "How"
  highlight: "it works"
  note: "No account. No API key. Just pay and compute."
  steps: ["HTTP request", "402", "Micropayment", "201 Running"]
```

**`manifesto`** — prose block, supports inline `**bold**`:
```yaml
- type: manifesto
  title: "Why"
  highlight: "x402"
  paragraphs:
    - "The internet has a status code for payments..."
    - "**Agents don't have emails.**"
```

**`pricing`** — pricing table (replaces I-1's per-page PRICING marker):
```yaml
- type: pricing
  note: "Pay per second. No minimums."
  columns: ["Action", "Cost", "Notes"]
  rows:
    - ["Wallet registration", "free", ""]
    - ["API call", "$0.001", "Per request"]
```
Template renders the `<table>` wrapper. No hand-written HTML needed.

**`cli`** — admin CLI block (prompt lines):
```yaml
- type: cli
  title: "Admin"
  highlight: "CLI"
  note: "For operators. Not for end users."
  commands:
    - "spawn node add --region nyc1"
    - "spawn capacity --region all"
```

Coming-soon pages use a minimal schema: `id, name, accent, tagline, sub, status` only. Template renders a placeholder hero with "coming soon" badge and no sections.

## Template Structure

Single `site/template.ts` file exports a `render(yaml: PrimConfig): string` function. Uses TypeScript tagged template literals (no library needed).

```
Page structure:
  <head> — title, CSS vars (accent from yaml), shared CSS
  <body>
    <div class="hero">
      logomark img
      breadcrumb nav
      logo (name.sh)
      tagline + sub
      cmd-block (hero_example)
      badges (hero_badges + status badge + "Part of prim.sh")
      scroll hint
    </div>
    for section in sections:
      render_section(section)
    <div class="cta-section">
      cta.headline + cta.sub + link
    </div>
    <footer>
      name — part of prim.sh | Docs | API | prim.sh
    </footer>
    <img banner>
```

CSS is inlined (not a separate file) to avoid an extra round-trip. The only thing injected from YAML into CSS is `--accent`, `--accent-dim`, `--accent-glow`.

### Fixing spawn's CSS drift

spawn currently uses `--green`/`--green-dim` hardcoded instead of `--accent`. Template normalizes all pages to use `--accent`. Each prim sets its own accent value in YAML. This fixes the inconsistency.

## serve.ts

New file: `site/serve.ts`. The current site is served by Cloudflare Pages (static file hosting) — serve.ts is net-new, not a replacement for any existing server. Port 3000 (follows prim service convention).

Responsibilities:
- Prim pages: load YAML → `render()` → respond with HTML + cache headers
- Static assets (`/assets/*`, `/llms.txt`, per-prim `llms.txt`) served from disk
- Non-prim pages (`/terms`, `/privacy`, `/access`, `/install`, `/install.sh`) served as static HTML from disk — no YAML for these
- All prim YAMLs loaded once at startup, cached in memory (no per-request disk read)
- `Cache-Control: public, max-age=300, s-maxage=300` on all rendered prim pages

Route resolution:
```
/                          → serve site/index.html (homepage — not converted in this task)
/<prim-id>                 → render from packages/<id>/prim.yaml or site/<id>/prim.yaml
/terms, /privacy, /access  → serve site/<name>/index.html (static)
/assets/*                  → serve site/assets/* from disk
/llms.txt                  → serve site/llms.txt from disk
/<prim-id>/llms.txt        → serve site/<prim-id>/llms.txt from disk
/install, /install.sh      → serve site/install.sh from disk
```

Prim ID list is derived at startup from all directories under `site/` that have a `prim.yaml` (or from `packages/*/prim.yaml`). No hardcoded route table — autodiscovered.

## Files to Delete (after serve.ts is working)

Per-prim `index.html` for all 10 built primitives (status: testing/built/production):
wallet, store, spawn, faucet, search, email, token, mem, domain, track

Coming-soon pages (21 unbuilt): ads, auth, browse, code, corp, cron, docs, hands, hive, id, infer, mart, pay, pins, pipe, ring, seek, ship, trace, vault, watch — these become minimal YAML-rendered stubs. Their current HTML can be deleted once minimal YAML is written.

Do NOT delete: `site/index.html` (homepage), `site/terms/`, `site/privacy/`, `site/access/`, `site/install*`.

## Deployment

1. Add `prim-site.service` systemd unit (port 3000, `bun run site/serve.ts`, restart on failure)
2. Add Caddy block: `prim.sh { reverse_proxy localhost:3000 }` (replaces CF Pages route)
3. Update Cloudflare DNS: `prim.sh` CNAME → VPS IP (already proxied, no change needed if CF proxies VPS)
4. Remove CF Pages project for `prim.sh` after VPS route is confirmed working

## Phases

1. **Extend prim.yaml** — add `accent`, `accent_dim`, `accent_glow` (extract hex from existing `:root` declarations) plus content fields (`tagline`, `sub`, `hero_badges`, `hero_example`, `cta`, `sections`) to the 10 built prim YAMLs (wallet, store, spawn, faucet, search, email, token, mem, domain, track). Extract content from existing HTML files. Check each section type against actual page content to ensure schema covers all variants.

2. **Write template.ts** — `render(config)` function. Test against wallet and spawn (most divergent pages). Verify output matches existing HTML visually before deleting anything.

3. **Write serve.ts** — YAML loader + template renderer + HTTP server. Route table as specified above. Test locally: `bun run site/serve.ts`.

4. **Add coming-soon YAMLs** — minimal schema for 21 unbuilt primitives. These just need `id, name, accent, accent_dim, accent_glow, tagline, sub, status`. One YAML per prim in `site/<id>/prim.yaml` (no package directory exists for these).

5. **Delete per-prim HTML** — only after serve.ts is locally verified for all pages.

6. **Deploy** — systemd unit + Caddy route + test on VPS. Switch DNS/CF Pages after confirming.

## Success Criteria

- `bun run site/serve.ts` serves all 31 prim pages locally with correct content
- Rendered HTML for wallet.sh is visually identical to current wallet/index.html
- No `--green` references in rendered output — all pages use `--accent`
- CSS is identical across all pages except `--accent` / `--accent-dim` / `--accent-glow`
- Live deploy: prim.sh/wallet loads, CF edge caches (`Age` response header increments on refresh)
- To update a status badge: edit prim.yaml, restart prim-site → change reflected immediately

## Before Closing

- [ ] All 10 built prim YAMLs have accent hex fields + full content fields (hero_example, sections, cta)
- [ ] All 21 unbuilt prim YAMLs exist with minimal fields (accent hex + tagline + sub + status)
- [ ] `bun run site/serve.ts` serves all pages without errors
- [ ] spawn page uses `--accent` not `--green` in rendered output
- [ ] Status badges render correctly (testing → "● Live (testnet)", built → "● Built", etc.)
- [ ] `/terms`, `/privacy`, `/access` still serve correctly from static HTML
- [ ] `/assets/hero.jpg`, `/assets/banner.jpg` still serve
- [ ] Per-prim `llms.txt` still serves from `site/<id>/llms.txt`
- [ ] `Cache-Control: public, max-age=300, s-maxage=300` on rendered pages
- [ ] VPS deploy: prim-site service running, Caddy routing prim.sh to port 3000
- [ ] CF Pages project removed or rerouted after VPS confirmed
- [ ] No `index.html` files for built primitives remain in git
